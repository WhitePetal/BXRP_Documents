<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BXRP: ProbeReferenceVolume.Streaming.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">BXRP<span id="projectnumber">&#160;V0.0.1</span>
   </div>
   <div id="projectbrief">基于UniySRP创建的自定义渲染管线</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_probe_reference_volume_8_streaming_8cs_source.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">ProbeReferenceVolume.Streaming.cs</div></div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="keyword">using </span>System.Collections;</div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="keyword">using </span>System.Collections.Generic;</div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="keyword">using </span>System.Diagnostics;</div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="keyword">using </span>Unity.Collections;</div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="keyword">using </span>Unity.Collections.LowLevel.Unsafe;</div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="keyword">using </span>Unity.IO.LowLevel.Unsafe;</div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="keyword">using </span>UnityEngine;</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="keyword">using </span>UnityEngine.Experimental.Rendering;</div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="keyword">using </span>UnityEngine.Rendering;</div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="keyword">using </span><a class="code hl_class" href="class_debug.html">Debug</a> = UnityEngine.Debug;</div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span> </div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespace_b_x_render_pipeline.html">BXRenderPipeline</a></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span>{</div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span>    <span class="keyword">using </span>Chunk = ProbeBrickPool.BrickChunkAlloc;</div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span> </div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span>    <span class="keyword">public</span> <span class="keyword">partial class </span><a class="code hl_class" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html">ProbeReferenceVolume</a></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span>    {</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span>        <span class="keyword">internal</span> <span class="keyword">class </span>DiskStreamingRequest</div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span>        {</div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span>            <span class="keyword">private</span> ReadHandle m_ReadHandle;</div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>            <span class="keyword">private</span> ReadCommandArray m_ReadCommandArray = <span class="keyword">new</span> ReadCommandArray();</div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span>            <span class="keyword">private</span> NativeArray&lt;ReadCommand&gt; m_ReadCommandBuffer;</div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>            <span class="keyword">private</span> <span class="keywordtype">int</span> m_BytesWritten;</div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span> </div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span>            <span class="keyword">public</span> DiskStreamingRequest(<span class="keywordtype">int</span> maxRequestCount)</div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>            {</div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>                m_ReadCommandBuffer = <span class="keyword">new</span> NativeArray&lt;ReadCommand&gt;(maxRequestCount, Allocator.Persistent);</div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span>            }</div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span> </div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>            <span class="keyword">public</span> unsafe <span class="keywordtype">void</span> AddReadCommand(<span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> size, <span class="keywordtype">byte</span>* dest)</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>            {</div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>                Debug.Assert(m_ReadCommandArray.CommandCount &lt; m_ReadCommandBuffer.Length);</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span> </div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>                m_ReadCommandBuffer[m_ReadCommandArray.CommandCount++] = <span class="keyword">new</span> ReadCommand()</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>                {</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>                    Buffer = dest,</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>                    Offset = offset,</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>                    <a class="code hl_enumvalue" href="namespace_b_x_render_pipeline.html#aa4a4b71e220a1b4f3576b66a92e49bf3a6f6cb72d544962fa333e2e34ce64f719">Size</a> = size</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>                };</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>                m_BytesWritten += size;</div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>            }</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span> </div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>            <span class="keyword">public</span> unsafe <span class="keywordtype">int</span> RunCommands(FileHandle file)</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>            {</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>                m_ReadCommandArray.ReadCommands = (ReadCommand*)m_ReadCommandBuffer.GetUnsafePtr();</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>                m_ReadHandle = AsyncReadManager.Read(file, m_ReadCommandArray);</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span> </div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>                <span class="keywordflow">return</span> m_BytesWritten;</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>            }</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span> </div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> Clear()</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>            {</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>                <span class="keywordflow">if</span> (m_ReadHandle.IsValid())</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>                    m_ReadHandle.JobHandle.Complete();</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>                m_ReadHandle = <span class="keywordflow">default</span>;</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>                m_ReadCommandArray.CommandCount = 0;</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>                m_BytesWritten = 0;</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>            }</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span> </div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> Cancle()</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>            {</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>                <span class="keywordflow">if</span> (m_ReadHandle.IsValid())</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>                    m_ReadHandle.Cancel();</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>            }</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span> </div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> Wait()</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>            {</div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>                <span class="keywordflow">if</span> (m_ReadHandle.IsValid())</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>                    m_ReadHandle.JobHandle.Complete();</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>            }</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span> </div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> Dispose()</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>            {</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>                m_ReadCommandBuffer.Dispose();</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>            }</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span> </div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>            <span class="keyword">public</span> ReadStatus GetStatus()</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span>            {</div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>                <span class="keywordflow">return</span> m_ReadHandle.IsValid() ? m_ReadHandle.Status : ReadStatus.Complete;</div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>            }</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>        }</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span> </div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>        [GenerateHLSL(needAccessors = <span class="keyword">false</span>, generateCBuffer = <span class="keyword">true</span>)]</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>        <span class="keyword">internal</span> <span class="keyword">struct </span>CellStreamingScratchBufferLayout</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>        {</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _SharedDestChunksOffset;</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L0L1rxOffset;</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L1GryOffset;</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L1BrzOffset;</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _ValidityOffset;</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _ProbeOcclusionOffset;</div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _SkyOcclusionOffset;</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _SkyShadingDirectionOffset;</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L2_0Offset;</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L2_1Offset;</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L2_2Offset;</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L2_3Offset;</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span> </div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L0Size;</div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L0ProbeSize; <span class="comment">// In bytes</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L1Size;</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L1ProbeSize; <span class="comment">// In bytes</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _ValiditySize;</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _ValidityProbeSize; <span class="comment">// In bytes</span></div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _ProbeOcclusionSize;</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _ProbeOcclusionProbeSize; <span class="comment">// In bytes</span></div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _SkyOcclusionSize;</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _SkyOcclusionProbeSize; <span class="comment">// In bytes</span></div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _SkyShadingDirectionSize;</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _SkyShadingDirectionProbeSize; <span class="comment">// In bytes</span></div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L2Size;</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _L2ProbeSize; <span class="comment">// In bytes</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span> </div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _ProbeCountInChunkLine;</div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> _ProbeCountInChunkSlice;</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>        }</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span> </div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>        <span class="keyword">internal</span> <span class="keyword">class </span>CellStreamingScratchBuffer</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>        {</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>            <span class="keyword">private</span> <span class="keywordtype">int</span> m_CurrentBuffer;</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>            <span class="keyword">private</span> GraphicsBuffer[] m_GraphicsBuffers;</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span> </div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>            <span class="comment">// The GraphicsBUffer is double buffer because the data upload shader might still be running</span></div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>            <span class="comment">// when we start a new streaming request</span></div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>            <span class="comment">// We could have double buffered at the CellStreamingScratchBuffer level itself but it would consume more memory (native+graphics buffer x2)</span></div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>            <span class="keyword">public</span> GraphicsBuffer buffer =&gt; m_GraphicsBuffers[m_CurrentBuffer];</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>            <span class="keyword">public</span> NativeArray&lt;byte&gt; stagingBuffer; <span class="comment">// Contains data streamed from disk. To be copied into the graphics buffer</span></div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> chunkSize { <span class="keyword">get</span>; }</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> chunkCount { <span class="keyword">get</span>; }</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span> </div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>            <span class="keyword">public</span> CellStreamingScratchBuffer(<span class="keywordtype">int</span> chunkCount, <span class="keywordtype">int</span> chunkSize, <span class="keywordtype">bool</span> allocatedGraphicsBuffers)</div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>            {</div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>                this.chunkCount = chunkCount;</div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>                this.chunkSize = chunkSize;</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span> </div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>                <span class="comment">// With a stride of 4 (one uint)</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>                <span class="comment">// Number of elements for chunk data: chunkCount * chunkSize / 4</span></div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>                <span class="comment">// Number of elements for dest chunk data (Vector4Int) : chunkCount * 4 * 4 / 4</span></div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>                var bufferSize = chunkCount * chunkSize / 4 + chunkCount * 4;</div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span> </div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>                <span class="comment">// Account for additional padding needed</span></div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>                bufferSize += 2 * chunkCount * <span class="keyword">sizeof</span>(uint);</div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span> </div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>                <span class="keywordflow">if</span> (allocatedGraphicsBuffers)</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>                {</div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 2; ++i)</div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>                        m_GraphicsBuffers[i] = <span class="keyword">new</span> GraphicsBuffer(GraphicsBuffer.Target.Raw, GraphicsBuffer.UsageFlags.LockBufferForWrite, bufferSize, <span class="keyword">sizeof</span>(uint));</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>                }</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span> </div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>                m_CurrentBuffer = 0;</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span> </div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>                stagingBuffer = <span class="keyword">new</span> NativeArray&lt;byte&gt;(bufferSize * <span class="keyword">sizeof</span>(uint), Allocator.Persistent);</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>            }</div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span> </div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> Swap()</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>            {</div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>                m_CurrentBuffer = (m_CurrentBuffer + 1) % 2;</div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>            }</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span> </div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> Dispose()</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>            {</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 2; ++i)</div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>                    m_GraphicsBuffers[i].Dispose();</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>                stagingBuffer.Dispose();</div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>            }</div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>        }</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span> </div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>        [DebuggerDisplay(<span class="stringliteral">&quot;Index = {cell.desc.index} State = {state}&quot;</span>)]</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>        <span class="keyword">internal</span> <span class="keyword">class </span>CellStreamingRequest</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>        {</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>            <span class="keyword">public</span> <span class="keyword">enum</span> State</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>            {</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>                Pending,</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>                Active,</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>                Canceled,</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>                Invalid,</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>                Complete</div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>            }</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span> </div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>            <span class="keyword">public</span> Cell cell { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>            <span class="keyword">public</span> State state { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>            <span class="keyword">public</span> CellStreamingScratchBuffer scratchBuffer { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>            <span class="keyword">public</span> CellStreamingScratchBufferLayout scratchBufferLayout { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span> </div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>            <span class="keyword">public</span> ProbeVolumeBakingSet.PerScenarioDataInfo scenarioData { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> poolIndex { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>            <span class="keyword">public</span> <span class="keywordtype">bool</span> streamSharedData { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span> </div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>            <span class="keyword">public</span> delegate <span class="keywordtype">void</span> OnStreamingCompeleteDelegate(CellStreamingRequest request, CommandBuffer cmd);</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>            <span class="keyword">public</span> OnStreamingCompeleteDelegate onStreamingCompelete = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span> </div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>            <span class="keyword">public</span> DiskStreamingRequest cellDataStreamingRequest = <span class="keyword">new</span> DiskStreamingRequest(1);</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>            <span class="keyword">public</span> DiskStreamingRequest cellOptionalDataStreamingRequest = <span class="keyword">new</span> DiskStreamingRequest(1);</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>            <span class="keyword">public</span> DiskStreamingRequest cellSharedDataStreamingRequest = <span class="keyword">new</span> DiskStreamingRequest(1);</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>            <span class="keyword">public</span> DiskStreamingRequest cellProbeOcclusionDataStreamingRequest = <span class="keyword">new</span> DiskStreamingRequest(1);</div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span>            <span class="keyword">public</span> DiskStreamingRequest brickStreamingRequest = <span class="keyword">new</span> DiskStreamingRequest(1);</div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>            <span class="keyword">public</span> DiskStreamingRequest supportStreamingRequest = <span class="keyword">new</span> DiskStreamingRequest(1);</div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span> </div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>            <span class="keyword">public</span> <span class="keywordtype">int</span> bytesWritten;</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span> </div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span>            <span class="keyword">public</span> <span class="keywordtype">bool</span> IsStreaming()</div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>            {</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span>                <span class="keywordflow">return</span> state == State.Pending || state == State.Active;</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>            }</div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span> </div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> Cancel()</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>            {</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>                <span class="keywordflow">if</span> (state == State.Active) </div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>                {</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>                    brickStreamingRequest.Cancle();</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span>                    supportStreamingRequest.Cancle();</div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span>                    cellDataStreamingRequest.Cancle();</div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>                    cellOptionalDataStreamingRequest.Cancle();</div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>                    cellSharedDataStreamingRequest.Cancle();</div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>                    cellProbeOcclusionDataStreamingRequest.Cancle();</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>                }</div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span> </div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>                state = State.Canceled;</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>            }</div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span> </div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> WaitAll()</div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span>            {</div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>                <span class="keywordflow">if</span> (state == State.Active)</div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span>                {</div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>                    brickStreamingRequest.Wait();</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>                    supportStreamingRequest.Wait();</div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span>                    cellDataStreamingRequest.Wait();</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span>                    cellOptionalDataStreamingRequest.Wait();</div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>                    cellSharedDataStreamingRequest.Wait();</div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>                    cellProbeOcclusionDataStreamingRequest.Wait();</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>                }</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span>            }</div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span> </div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>            <span class="keyword">public</span> <span class="keywordtype">bool</span> UpdateRequestState(DiskStreamingRequest request, ref <span class="keywordtype">bool</span> isCompelete)</div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span>            {</div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span>                var status = request.GetStatus();</div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>                <span class="keywordflow">if</span> (status == ReadStatus.Failed)</div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>                    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span> </div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span>                isCompelete &amp;= request.GetStatus() == ReadStatus.Complete;</div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>            }</div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span> </div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> UpdateState()</div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>            {</div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>                <span class="keywordflow">if</span>(state == State.Active)</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>                {</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>                    <span class="keywordtype">bool</span> isCompelte = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>                    <span class="keywordtype">bool</span> success = UpdateRequestState(brickStreamingRequest, ref isCompelte);</div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>                    success &amp;= UpdateRequestState(supportStreamingRequest, ref isCompelte);</div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span>                    success &amp;= UpdateRequestState(cellDataStreamingRequest, ref isCompelte);</div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span>                    success &amp;= UpdateRequestState(cellOptionalDataStreamingRequest, ref isCompelte);</div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span>                    success &amp;= UpdateRequestState(cellSharedDataStreamingRequest, ref isCompelte);</div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>                    success &amp;= UpdateRequestState(cellProbeOcclusionDataStreamingRequest, ref isCompelte);</div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span> </div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span>                    <span class="keywordflow">if</span> (!success)</div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span>                    {</div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>                        Cancel(); <span class="comment">// At least one of the requests failed. Cancel the others.</span></div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>                        state = State.Invalid;</div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>                    }</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span>                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isCompelte)</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span>                    {</div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span>                        state = State.Complete;</div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>                    }</div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span>                }</div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span>            }</div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span> </div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> Clear()</div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>            {</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>                cell = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>                Reset();</div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span>            }</div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span> </div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> Reset()</div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>            {</div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>                state = State.Pending;</div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span>                scratchBuffer = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>                brickStreamingRequest.Clear();</div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>                supportStreamingRequest.Clear();</div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>                cellDataStreamingRequest.Clear();</div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>                cellOptionalDataStreamingRequest.Clear();</div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span>                cellSharedDataStreamingRequest.Clear();</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>                cellProbeOcclusionDataStreamingRequest.Clear();</div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span>                bytesWritten = 0;</div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span>            }</div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span> </div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>            <span class="keyword">public</span> <span class="keywordtype">void</span> Dispose()</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span>            {</div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span>                brickStreamingRequest.Dispose();</div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span>                supportStreamingRequest.Dispose();</div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span>                cellDataStreamingRequest.Dispose();</div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>                cellOptionalDataStreamingRequest.Dispose();</div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span>                cellSharedDataStreamingRequest.Dispose();</div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span>                cellProbeOcclusionDataStreamingRequest.Dispose();</div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>            }</div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span>        }</div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span> </div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span><span class="preprocessor">#if UNITY_EDITOR</span></div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span>        <span class="comment">// By default on editor we load a lot of cells in one go to avoid having to mess with scene view</span></div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span>        <span class="comment">// to see results, this value can still be changed via API.</span></div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span>        <span class="keyword">private</span> <span class="keywordtype">bool</span> m_LoadMaxCellsPerFrame = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span>        <span class="keyword">private</span> <span class="keywordtype">bool</span> m_LoadMaxCellsPerFrame = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span></div>
<div class="foldopen" id="foldopen00310" data-start="{" data-end="}">
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno"><a class="line" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#af2f32385d2f6bab0b12b5273aedfb6f7">  310</a></span>        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#af2f32385d2f6bab0b12b5273aedfb6f7">EnableMaxCellStreaming</a>(<span class="keywordtype">bool</span> value)</div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>        {</div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>            m_LoadMaxCellsPerFrame = value;</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span>        }</div>
</div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span> </div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">int</span> kMaxCellLoadedPerFrame = 10;</div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>        <span class="keyword">private</span> <span class="keywordtype">int</span> m_NumberOfCellsLoadedPerFrame = 1;</div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span></div>
<div class="foldopen" id="foldopen00322" data-start="{" data-end="}">
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno"><a class="line" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3ef101369ba2153ba30b9212185f6a26">  322</a></span>        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3ef101369ba2153ba30b9212185f6a26">SetNumberOfCellsLoadedPerFrame</a>(<span class="keywordtype">int</span> numberOfCells)</div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span>        {</div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span>            m_NumberOfCellsLoadedPerFrame = Mathf.Min(kMaxCellLoadedPerFrame, Mathf.Max(1, numberOfCells));</div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span>        }</div>
</div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span> </div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> loadMaxCellsPerFrame</div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span>        {</div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>            <span class="keyword">get</span> =&gt; m_LoadMaxCellsPerFrame;</div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>            <span class="keyword">set</span> =&gt; m_LoadMaxCellsPerFrame = value;</div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>        }</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span> </div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span>        <span class="keyword">private</span> <span class="keywordtype">int</span> numberOfCellsLoadedPerFrame =&gt; m_LoadMaxCellsPerFrame ? cells.Count : m_NumberOfCellsLoadedPerFrame;</div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span> </div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span>        <span class="keyword">private</span> <span class="keywordtype">int</span> m_NumberOfCellsBlendedPerFrame = 10000;</div>
<div class="foldopen" id="foldopen00339" data-start="{" data-end="};">
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno"><a class="line" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a7eab7cb9d69e825678f242112954861e">  339</a></span>        <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a7eab7cb9d69e825678f242112954861e">numberOfCellsBlendedPerFrame</a></div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span>        {</div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>            <span class="keyword">get</span> =&gt; m_NumberOfCellsBlendedPerFrame;</div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>            <span class="keyword">set</span> =&gt; m_NumberOfCellsBlendedPerFrame = Mathf.Max(1, value);</div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>        }</div>
</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span> </div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>        <span class="keyword">private</span> <span class="keywordtype">float</span> m_TurnoverRate = 0.1f;</div>
<div class="foldopen" id="foldopen00349" data-start="{" data-end="};">
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno"><a class="line" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3bad87525c6f99d81e2e92d332107ae4">  349</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3bad87525c6f99d81e2e92d332107ae4">turnoverRate</a></div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span>        {</div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>            <span class="keyword">get</span> =&gt; m_TurnoverRate;</div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span>            <span class="keyword">set</span> =&gt; m_TurnoverRate = Mathf.Clamp01(value);</div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span>        }</div>
</div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span> </div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_LoadedCells = <span class="keyword">new</span>(); <span class="comment">// List of currently loaded cells</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_ToBeLoadedCells = <span class="keyword">new</span>(); <span class="comment">// List of currently unloaded cells</span></div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_WorseLoadedCells = <span class="keyword">new</span>(); <span class="comment">// Reduced list (N cells are processed per frame) of worse loaded cells.</span></div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_BestToBeLoadedCells = <span class="keyword">new</span>();  <span class="comment">// Reduced list (N cells are processed per frame) of best unloaded cells.</span></div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_TempCellToLoadList = <span class="keyword">new</span>(); <span class="comment">// Temp list of cells loaded during this frame.</span></div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_TempCellToUnloadList = <span class="keyword">new</span>(); <span class="comment">// Temp list of cells unloaded during this frame.</span></div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span> </div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_LoadedBlendingCells = <span class="keyword">new</span>();</div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_ToBeLoadedBlendingCells = <span class="keyword">new</span>();</div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_TempBlendingCellToLoadList = <span class="keyword">new</span>();</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_TempBlendingCellToUnloadList = <span class="keyword">new</span>();</div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span> </div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span>        <span class="keyword">private</span> Vector3 m_FrozenCameraPosition;</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span>        <span class="keyword">private</span> Vector3 m_FrozenCameraDirection;</div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span> </div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">float</span> kIndexFragmentationThreshold = 0.2f;</div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>        <span class="keyword">private</span> <span class="keywordtype">bool</span> m_IndexDefragmentationInProgress;</div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>        <span class="keyword">private</span> ProbeBrickIndex m_DefragIndex;</div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>        <span class="keyword">private</span> ProbeGlobalIndirection m_DefragCellIndices;</div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span> </div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_IndexDefragCells = <span class="keyword">new</span> ();</div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>        <span class="keyword">private</span> DynamicArray&lt;Cell&gt; m_TempIndexDefragCells = <span class="keyword">new</span>();</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span> </div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span>        <span class="keyword">internal</span> <span class="keywordtype">float</span> minStreamingScore;</div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>        <span class="keyword">internal</span> <span class="keywordtype">float</span> maxStreamingScore;</div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span> </div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>        <span class="comment">// Requests waiting to be run. Needed to preserve order of requests.</span></div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>        <span class="keyword">private</span> Queue&lt;CellStreamingRequest&gt; m_StreamingQueue = <span class="keyword">new</span> Queue&lt;CellStreamingRequest&gt;();</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span> </div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>        <span class="comment">// List of active requests. Needed to query the result every frame.</span></div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span>        <span class="keyword">private</span> List&lt;CellStreamingRequest&gt; m_ActiveStreamingRequests = <span class="keyword">new</span> List&lt;CellStreamingRequest&gt;();</div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span> </div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>        <span class="keyword">private</span> ObjectPool&lt;CellStreamingRequest&gt; m_StreamingRequestsPool = <span class="keyword">new</span> ObjectPool&lt;CellStreamingRequest&gt;(<span class="keyword">null</span>, (val) =&gt; val.Clear());</div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span> </div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>        <span class="keyword">private</span> <span class="keywordtype">bool</span> m_DiskStreamingUseCompute = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span> </div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span>        <span class="keyword">private</span> ProbeVolumeScratchBufferPool m_ScratchBufferPool;</div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span> </div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span>        <span class="keyword">private</span> CellStreamingRequest.OnStreamingCompeleteDelegate m_OnStreamingComplete;</div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>        <span class="keyword">private</span> CellStreamingRequest.OnStreamingCompeleteDelegate m_OnBlendingStreamingComplete;</div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span> </div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> InitStreaming()</div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span>        {</div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span>            m_OnStreamingComplete = OnStreamingComplete;</div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span>            m_OnBlendingStreamingComplete = OnBlendingStreamingComplete;</div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span>        }</div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span> </div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> CleanupStreaming()</div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span>        {</div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span>            <span class="comment">// Releases all active and pending canceled requests.</span></div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span>            ProcessNewRequests();</div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span>            UpdateActiveRequests(<span class="keyword">null</span>);</div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span> </div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span>            <a class="code hl_class" href="class_debug.html">Debug</a>.Assert(m_StreamingQueue.Count == 0);</div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span>            <a class="code hl_class" href="class_debug.html">Debug</a>.Assert(m_ActiveStreamingRequests.Count == 0);</div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span>            <a class="code hl_class" href="class_debug.html">Debug</a>.Assert(m_StreamingRequestsPool.countAll == m_StreamingRequestsPool.countInactive); <span class="comment">// Everything should have been released.</span></div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span> </div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; m_StreamingRequestsPool.countAll; ++i)</div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>            {</div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span>                var request = m_StreamingRequestsPool.Get();</div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span>                request.Dispose();</div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span>            }</div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span> </div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span>            <span class="keywordflow">if</span> (m_ScratchBufferPool != <span class="keyword">null</span>)</div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span>            {</div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span>                m_ScratchBufferPool.Cleanup();</div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span>                m_ScratchBufferPool = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>            }</div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span> </div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span>            m_StreamingRequestsPool = <span class="keyword">new</span> ObjectPool&lt;CellStreamingRequest&gt;((val) =&gt; val.Clear(), <span class="keyword">null</span>);</div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>            m_ActiveStreamingRequests.Clear();</div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span>            m_StreamingQueue.Clear();</div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span> </div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span>            m_OnStreamingComplete = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span>            m_OnBlendingStreamingComplete = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span>        }</div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span> </div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span>        <span class="keyword">internal</span> <span class="keywordtype">void</span> ScenarioBlendingChanged(<span class="keywordtype">bool</span> scenarioChanged)</div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span>        {</div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span>            <span class="keywordflow">if</span> (scenarioChanged)</div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span>            {</div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span>                UnloadAllBlendingCells();</div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; m_ToBeLoadedBlendingCells.size; ++i)</div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span>                {</div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>                    m_ToBeLoadedBlendingCells[i].blendingInfo.ForceReupload();</div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>                }</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>            }</div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>        }</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span> </div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">void</span> ComputeCellStreamingScore(Cell cell, Vector3 cameraPosition, Vector3 cameraDirection)</div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span>        {</div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span>            var cellPosition = cell.desc.position;</div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span>            var cameraToCell = (cellPosition - cameraPosition).normalized;</div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span>            cell.streamingInfo.streamingScore = Vector3.Distance(cellPosition, cameraPosition);</div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span>            <span class="comment">// This should give more weight to cells in front of the camera.</span></div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span>            cell.streamingInfo.streamingScore *= (2f - Vector3.Dot(cameraToCell, cameraDirection));</div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span>        }</div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span> </div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> ComputeStreamingScore(Vector3 cameraPosition, Vector3 cameraDirection, DynamicArray&lt;Cell&gt; cells)</div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span>        {</div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span>            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; cells.size; ++i)</div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span>                ComputeCellStreamingScore(cells[i], cameraPosition, cameraDirection);</div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span>        }</div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span> </div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> ComputeBestToBeLoadedCells(Vector3 cameraPosition, Vector3 cameraDirection)</div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span>        {</div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>            m_BestToBeLoadedCells.Clear();</div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span>            m_BestToBeLoadedCells.Reserve(m_ToBeLoadedCells.size); <span class="comment">// Pre-reserve to avoid Insert allocating every time.</span></div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span> </div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span>            <span class="keywordflow">foreach</span>(var cell <span class="keywordflow">in</span> m_ToBeLoadedCells)</div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span>            {</div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span>                ComputeCellStreamingScore(cell, cameraPosition, cameraDirection);</div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span> </div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span>                <span class="comment">// We need to compute min/max streaming scores here since we don&#39;t have the full sorted list anymore (which is used in ComputeMinMaxStreamingScore)</span></div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span>                minStreamingScore = Mathf.Min(minStreamingScore, cell.streamingInfo.streamingScore);</div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span>                maxStreamingScore = Mathf.Max(maxStreamingScore, cell.streamingInfo.streamingScore);</div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span> </div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span>                <span class="keywordtype">int</span> currentBestCellSize = System.Math.Min(m_BestToBeLoadedCells.size, numberOfCellsLoadedPerFrame);</div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>                <span class="keywordtype">int</span> index;</div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span>                <span class="keywordflow">for</span>(index = 0; index &lt; currentBestCellSize; ++index)</div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span>                {</div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span>                    <span class="keywordflow">if</span> (cell.streamingInfo.streamingScore &lt; m_BestToBeLoadedCells[index].streamingInfo.streamingScore)</div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span>                }</div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span> </div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span>                <span class="keywordflow">if</span> (index &lt; numberOfCellsLoadedPerFrame)</div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span>                    m_BestToBeLoadedCells.Insert(index, cell);</div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span> </div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span>                <span class="comment">// Avoids too many copies when Inserting new elements.</span></div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>                <span class="keywordflow">if</span> (m_BestToBeLoadedCells.size &gt; numberOfCellsLoadedPerFrame)</div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span>                    m_BestToBeLoadedCells.Resize(numberOfCellsLoadedPerFrame);</div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span>            }</div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span>        }</div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span> </div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> ComputeStreamingScoreAndWorseLoadedCells(Vector3 cameraPosition, Vector3 cameraDirection)</div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span>        {</div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span>            m_WorseLoadedCells.Clear();</div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>            m_WorseLoadedCells.Reserve(m_LoadedCells.size); <span class="comment">// Pre-reserve to avoid Insert allocating every time.</span></div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span> </div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span>            <span class="keywordtype">int</span> requiredSHChunks = 0;</div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span>            <span class="keywordtype">int</span> requiredIndexChunks = 0;</div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span>            <span class="keywordflow">foreach</span>(var cell <span class="keywordflow">in</span> m_BestToBeLoadedCells)</div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>            {</div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span>                requiredSHChunks += cell.desc.shChunkCount;</div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span>                requiredIndexChunks += cell.desc.indexChunkCount;</div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span>            }</div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span> </div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>            <span class="keywordflow">foreach</span>(var cell <span class="keywordflow">in</span> m_LoadedCells)</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>            {</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>                ComputeCellStreamingScore(cell, cameraPosition, cameraDirection);</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span> </div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>                <span class="comment">// We need to compute min/max streaming scores here since we don&#39;t have the full sorted list anymore (which is used in ComputeMinMaxStreamingScore)</span></div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>                minStreamingScore = Mathf.Min(minStreamingScore, cell.streamingInfo.streamingScore);</div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>                maxStreamingScore = Mathf.Max(maxStreamingScore, cell.streamingInfo.streamingScore);</div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span> </div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>                <span class="keywordtype">int</span> currentWorseSize = m_WorseLoadedCells.size;</div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span>                <span class="keywordtype">int</span> index;</div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>                <span class="keywordflow">for</span>(index = 0; index &lt; currentWorseSize; ++index)</div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>                {</div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span>                    <span class="keywordflow">if</span> (cell.streamingInfo.streamingScore &lt; m_WorseLoadedCells[index].streamingInfo.streamingScore)</div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>                }</div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span> </div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span>                m_WorseLoadedCells.Insert(index, cell);</div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span> </div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span>                <span class="comment">// Compute the chunk counts of the current worse cells.</span></div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span>                <span class="keywordtype">int</span> currentSHChunks = 0;</div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span>                <span class="keywordtype">int</span> currentIndexChunks = 0;</div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span>                <span class="keywordtype">int</span> newSize = 0;</div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span>                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; m_WorseLoadedCells.size; ++i)</div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span>                {</div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span>                    var worseCell = m_WorseLoadedCells[i];</div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span>                    currentSHChunks += worseCell.desc.shChunkCount;</div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>                    currentIndexChunks += worseCell.desc.indexChunkCount;</div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span> </div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span>                    <span class="keywordflow">if</span>(currentSHChunks &gt;= requiredSHChunks &amp;&amp; currentIndexChunks &gt;= requiredIndexChunks)</div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span>                    {</div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span>                        newSize = i + 1;</div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span>                    }</div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span>                }</div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span> </div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span>                <span class="comment">// Now we resize to keep just enough worse cells that represent enough room to load the required cell.</span></div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span>                <span class="comment">// This allows insertions to be cheaper.</span></div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span>                <span class="keywordflow">if</span> (newSize != 0)</div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span>                    m_WorseLoadedCells.Resize(newSize);</div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span>            }</div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>        }</div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span> </div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> ComputeBlendingScore(DynamicArray&lt;Cell&gt; cells, <span class="keywordtype">float</span> worstScore)</div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span>        {</div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span>            <span class="keywordtype">float</span> factor = <a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a9ed1b93bf407ee958f2eff108b148023">scenarioBlendingFactor</a>;</div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; cells.size; ++i)</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>            {</div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span>                var cell = cells[i];</div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span>                var blendingInfo = cell.blendingInfo;</div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span>                <span class="keywordflow">if</span>(factor != blendingInfo.blendingFactor)</div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span>                {</div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span>                    blendingInfo.blendingScore = cell.streamingInfo.streamingScore;</div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span>                    <span class="keywordflow">if</span> (blendingInfo.ShouldPrioritize())</div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span>                        blendingInfo.blendingScore -= worstScore;</div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span>                }</div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span>            }</div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span>        }</div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span> </div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span>        <span class="keyword">private</span> <span class="keywordtype">bool</span> TryLoadCell(Cell cell, ref <span class="keywordtype">int</span> shBudget, ref <span class="keywordtype">int</span> indexBudget, DynamicArray&lt;Cell&gt; loadedCells)</div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span>        {</div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span>            <span class="comment">// Are we within budget?</span></div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span>            <span class="keywordflow">if</span>(cell.poolInfo.shChunkCount &lt;= shBudget &amp;&amp; cell.indexInfo.indexChunkCount &lt;= indexBudget)</div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span>            {</div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span>                <span class="comment">// This can still fail because of fragmentation.</span></div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span>                <span class="keywordflow">if</span>(LoadCell(cell, ignoreErrorLog: <span class="keyword">true</span>))</div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span>                {</div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span>                    loadedCells.Add(cell);</div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span> </div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span>                    shBudget -= cell.poolInfo.shChunkCount;</div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span>                    indexBudget -= cell.indexInfo.indexChunkCount;</div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span> </div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span>                    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span>                }</div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span>            }</div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span> </div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span>        }</div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span> </div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> UnloadBlendingCell(Cell cell, DynamicArray&lt;Cell&gt; unloadedCells)</div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span>        {</div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span>            UnloadBlendingCell(cell);</div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span>            unloadedCells.Add(cell);</div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span>        }</div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span> </div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span>        <span class="keyword">private</span> <span class="keywordtype">bool</span> TryLoadBlendingCell(Cell cell, DynamicArray&lt;Cell&gt; loadedCells)</div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span>        {</div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span>            <span class="keywordflow">if</span> (!cell.UpdateCellScenarioData(<a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#afb6970d042bc02dc1babd7d4f70e31e5">lightingScenario</a>, m_CurrentBakingSet.otherScenario))</div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span> </div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span>            <span class="keywordflow">if</span> (!AddBlendingBricks(cell))</div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span> </div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span>            loadedCells.Add(cell);</div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span> </div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span>        }</div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span> </div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> ComputeMinMaxStreamingScore()</div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span>        {</div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span>            minStreamingScore = <span class="keywordtype">float</span>.MaxValue;</div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span>            maxStreamingScore = <span class="keywordtype">float</span>.MinValue;</div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span> </div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span>            <span class="keywordflow">if</span>(m_ToBeLoadedCells.size != 0)</div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span>            {</div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span>                minStreamingScore = Mathf.Min(minStreamingScore, m_ToBeLoadedCells[0].streamingInfo.streamingScore);</div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span>                maxStreamingScore = Mathf.Max(maxStreamingScore, m_ToBeLoadedCells[m_ToBeLoadedCells.size - 1].streamingInfo.streamingScore);</div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span>            }</div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span> </div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span>            <span class="keywordflow">if</span>(m_LoadedCells.size != 0)</div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span>            {</div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span>                minStreamingScore = Mathf.Min(minStreamingScore, m_LoadedCells[0].streamingInfo.streamingScore);</div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span>                maxStreamingScore = Mathf.Max(maxStreamingScore, m_LoadedCells[m_LoadedCells.size - 1].streamingInfo.streamingScore);</div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span>            }</div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span>        }</div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span></div>
<div class="foldopen" id="foldopen00622" data-start="{" data-end="}">
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno"><a class="line" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3a0771648f1d82379509866ce0ca87af">  622</a></span>        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3a0771648f1d82379509866ce0ca87af">UpdateCellStreaming</a>(CommandBuffer cmd, <a class="code hl_class" href="class_camera.html">Camera</a> camera)</div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span>        {</div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span>            <a class="code hl_function" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3a0771648f1d82379509866ce0ca87af">UpdateCellStreaming</a>(cmd, camera, <span class="keyword">null</span>);</div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>        }</div>
</div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span></div>
<div class="foldopen" id="foldopen00633" data-start="{" data-end="}">
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno"><a class="line" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a9d1ed2f6fa0098440b5af9e9dc10e637">  633</a></span>        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a9d1ed2f6fa0098440b5af9e9dc10e637">UpdateCellStreaming</a>(CommandBuffer cmd, <a class="code hl_class" href="class_camera.html">Camera</a> camera, <a class="code hl_class" href="class_b_x_render_pipeline_1_1_probe_volumes_options.html">ProbeVolumesOptions</a> options)</div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span>        {</div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span>            <span class="keywordflow">if</span> (!<a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a91758a40094d4965422f95e8e818661c">isInitialized</a> || m_CurrentBakingSet == <span class="keyword">null</span>)</div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span>                <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span> </div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>            <span class="keyword">using</span>(<span class="keyword">new</span> ProfilingScope(<span class="keyword">null</span>, ProfilingSampler.Get(BXProfileId.APVCellStreamingUpdate)))</div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>            {</div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>                var cameraPosition = camera.transform.position;</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span>                <span class="keywordflow">if</span> (!probeVolumeDebug.freezeStreaming)</div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span>                {</div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span>                    m_FrozenCameraPosition = cameraPosition;</div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span>                    m_FrozenCameraDirection = camera.transform.forward;</div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span>                }</div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span> </div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>                <span class="comment">// Cell position in cell space is the top left corner. So we need to shift the camera position by half a cell to make things comparable.</span></div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span>                var offset = ProbeOffset() + (options != <span class="keyword">null</span> ? options.worldOffset : Vector3.zero);</div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span>                var cameraPositionCellSpace = (m_FrozenCameraPosition - offset) / MaxBrickSize() - Vector3.one * 0.5f;</div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span> </div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span>                DynamicArray&lt;Cell&gt; bestUnloadedCells;</div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span>                DynamicArray&lt;Cell&gt; worseLoadedCells;</div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span> </div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span>                <span class="comment">// When in this mode, we just sort through all loaded/ToBeLoaded cells in order to figure out worse/best cells to process.</span></div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span>                <span class="comment">// This is slow so only recommended in the editor.</span></div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span>                <span class="keywordflow">if</span> (m_LoadMaxCellsPerFrame)</div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span>                {</div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span>                    ComputeStreamingScore(cameraPositionCellSpace, m_FrozenCameraDirection, m_ToBeLoadedCells);</div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span>                    m_ToBeLoadedCells.QuickSort();</div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span>                    bestUnloadedCells = m_ToBeLoadedCells;</div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span>                }</div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span>                <span class="comment">// Otherwise, when we only process a handful of cells per frame, we&#39;ll linearly go through the lists to determine two things:</span></div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span>                <span class="comment">// - The list of best cells to load.</span></div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span>                <span class="comment">// - The list of worse cells to load. This list can be bigger than the previous one since cells have different sizes so we may need to evict more to make room.</span></div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span>                <span class="comment">// This allows us to not sort through all the cells every frame which is very slow. Instead we just output very small lists that we then process.</span></div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span>                {</div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span>                    minStreamingScore = <span class="keywordtype">float</span>.MaxValue;</div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span>                    maxStreamingScore = <span class="keywordtype">float</span>.MinValue;</div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span> </div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span>                    ComputeBestToBeLoadedCells(cameraPositionCellSpace, m_FrozenCameraDirection);</div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span>                    bestUnloadedCells = m_BestToBeLoadedCells;</div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>                }</div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span> </div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span>                <span class="comment">// This is only a rough budget estimate at first.</span></div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span>                <span class="comment">// It doesn&#39;t account for fragmentation.</span></div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span>                <span class="keywordtype">int</span> indexChunkBudget = m_Index.GetRemainingChunkCount();</div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span>                <span class="keywordtype">int</span> shChunkBudget = m_Pool.GetRemainingChunkCount();</div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span>                <span class="keywordtype">int</span> cellCountToLoad = Mathf.Min(numberOfCellsLoadedPerFrame, bestUnloadedCells.<a class="code hl_property" href="class_b_x_render_pipeline_1_1_dynamic_array-1-g.html#abd35e7271b8c0ff05db8199e28594647">size</a>);</div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span> </div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span>                <span class="keywordtype">bool</span> didRecomputeScoresForLoadedCells = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span>                <span class="keywordflow">if</span> (m_SupportGPUStreaming)</div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span>                {</div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span>                    <span class="keywordflow">if</span> (m_IndexDefragmentationInProgress)</div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span>                    {</div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span>                        UpdateIndexDefragmentation();</div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span>                    }</div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span>                    <span class="keywordflow">else</span></div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span>                    {</div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>                        <span class="keywordtype">bool</span> needComputeFragmentation = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span> </div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>                        <span class="keywordflow">while</span>(m_TempCellToLoadList.size &lt; cellCountToLoad)</div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span>                        {</div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span>                            <span class="comment">// Enough memory, we can safely load the cell.</span></div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span>                            var cellInfo = bestUnloadedCells[m_TempCellToLoadList.size];</div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>                            <span class="keywordflow">if</span> (!TryLoadCell(cellInfo, ref shChunkBudget, ref indexChunkBudget, m_TempCellToLoadList))</div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span>                                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span>                        }</div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno">  699</span> </div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span>                        <span class="comment">// Budget reached. We need to figure out if we can safely unload other cells to make room.</span></div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span>                        <span class="comment">// If defrag was triggered by TryLoadCell we should not try to load further cells either.</span></div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span>                        <span class="keywordflow">if</span>(m_TempCellToLoadList.size != cellCountToLoad &amp;&amp; !m_IndexDefragmentationInProgress)</div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span>                        {</div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span>                            <span class="comment">// We need to unload cells so we have to compute the worse loaded cells now (not earlier as it would be useless)</span></div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span>                            <span class="keywordflow">if</span> (m_LoadMaxCellsPerFrame)</div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span>                            {</div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span>                                ComputeStreamingScore(cameraPositionCellSpace, m_FrozenCameraDirection, m_LoadedCells);</div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span>                                m_LoadedCells.QuickSort();</div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span>                                worseLoadedCells = m_LoadedCells;</div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span>                            }</div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span>                            <span class="keywordflow">else</span></div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span>                            {</div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span>                                ComputeStreamingScoreAndWorseLoadedCells(cameraPositionCellSpace, m_FrozenCameraDirection);</div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span>                                worseLoadedCells = m_WorseLoadedCells;</div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span>                            }</div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span>                            didRecomputeScoresForLoadedCells = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span> </div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span>                            <span class="keywordtype">int</span> pendingUnloadCount = 0;</div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span>                            <span class="keywordflow">while</span>(m_TempCellToLoadList.size &lt; cellCountToLoad)</div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span>                            {</div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span>                                <span class="comment">// No more cells to unload.</span></div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span>                                <span class="keywordflow">if</span> (worseLoadedCells.<a class="code hl_property" href="class_b_x_render_pipeline_1_1_dynamic_array-1-g.html#abd35e7271b8c0ff05db8199e28594647">size</a> - pendingUnloadCount == 0)</div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span>                                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span> </div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span>                                <span class="comment">// List are stored in reverse order depending on the mode.</span></div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span>                                <span class="comment">// TODO make the full List be sorted the same way as partial list.</span></div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span>                                <span class="keywordtype">int</span> worseCellIndex = m_LoadMaxCellsPerFrame ? worseLoadedCells.size - pendingUnloadCount - 1 : pendingUnloadCount;</div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span>                                var worseLoadedCell = worseLoadedCells[worseCellIndex];</div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span>                                var bestUnloadedCell = bestUnloadedCells[m_TempCellToLoadList.size];</div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span> </div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span>                                <span class="comment">// We are in a &quot;stable&quot; state, all the closest cells are loaded within the budget.</span></div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>                                <span class="keywordflow">if</span> (worseLoadedCell.streamingInfo.streamingScore &lt;= bestUnloadedCell.streamingInfo.streamingScore)</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>                                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span> </div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span>                                <span class="comment">// The worse loaded cell is further than the best unloaded cell, we can unload it.</span></div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span>                                <span class="keywordflow">while</span>(pendingUnloadCount &lt; worseLoadedCells.size &amp;&amp; worseLoadedCell.streamingInfo.streamingScore &gt; bestUnloadedCell.streamingInfo.streamingScore</div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span>                                    &amp;&amp; (shChunkBudget &lt; bestUnloadedCell.desc.shChunkCount || indexChunkBudget &lt; bestUnloadedCell.desc.indexChunkCount))</div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span>                                {</div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span>                                    <span class="keywordflow">if</span> (probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span>                                        LogStreaming($<span class="stringliteral">&quot;Unloading cell {worseLoadedCell.desc.index}&quot;</span>);</div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span> </div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span>                                    pendingUnloadCount++;</div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span>                                    UnloadCell(worseLoadedCell);</div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span>                                    shChunkBudget += worseLoadedCell.desc.shChunkCount;</div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span>                                    indexChunkBudget += worseLoadedCell.desc.indexChunkCount;</div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span> </div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span>                                    m_TempCellToUnloadList.Add(worseLoadedCell);</div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span> </div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span>                                    worseCellIndex = m_LoadMaxCellsPerFrame ? worseLoadedCells.size - pendingUnloadCount - 1 : pendingUnloadCount;</div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span>                                    <span class="keywordflow">if</span> (pendingUnloadCount &lt; worseLoadedCells.<a class="code hl_property" href="class_b_x_render_pipeline_1_1_dynamic_array-1-g.html#abd35e7271b8c0ff05db8199e28594647">size</a>)</div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>                                        worseLoadedCell = worseLoadedCells[worseCellIndex];</div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>                                }</div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span> </div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span>                                <span class="comment">// We unloaded enough space (not taking fragmentation into account)</span></div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span>                                <span class="keywordflow">if</span>(shChunkBudget &gt;= bestUnloadedCell.desc.shChunkCount &amp;&amp; indexChunkBudget &gt;= bestUnloadedCell.desc.indexChunkCount)</div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span>                                {</div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span>                                    <span class="keywordflow">if</span>(!TryLoadCell(bestUnloadedCell, ref shChunkBudget, ref indexChunkBudget, m_TempCellToLoadList))</div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span>                                    {</div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span>                                        needComputeFragmentation = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>                                        <span class="keywordflow">break</span>; <span class="comment">// Alloc failed because of fragmentation, stop trying to load cells.</span></div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span>                                    }</div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span>                                }</div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span>                            }</div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span>                        }</div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span> </div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span>                        <span class="keywordflow">if</span> (needComputeFragmentation)</div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>                            m_Index.ComputeFragmentationRate();</div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span> </div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span>                        <span class="keywordflow">if</span> (m_Index.fragmentationRate &gt;= kIndexFragmentationThreshold)</div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span>                            StartIndexDefragmentation();</div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span>                    }</div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span>                }</div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span>                {</div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span>                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; cellCountToLoad; ++i)</div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span>                    {</div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span>                        var cellInfo = m_ToBeLoadedCells[m_TempCellToLoadList.size]; <span class="comment">// m_TempCellToLoadList.size get incremented in TryLoadCell</span></div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span>                        <span class="keywordflow">if</span>(!TryLoadCell(cellInfo, ref shChunkBudget, ref indexChunkBudget, m_TempCellToLoadList))</div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span>                        {</div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span>                            <span class="keywordflow">if</span> (i &gt; 0) <span class="comment">// Only warn once</span></div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span>                            {</div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span>                                Debug.LogWarning(<span class="stringliteral">&quot;Max Memory Budget for Adaptive Probe Volumes has been reached, but there is still more data to load. Consider either increasing the Memory Budget, enabling GPU Streaming, or reducing the probe count.&quot;</span>);</div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span>                            }</div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>                            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span>                        }</div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span>                    }</div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span>                }</div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span> </div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span>                <span class="comment">// If we intend to blend scenarios, compute the streaming scores for the already loaded cells.</span></div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>                <span class="comment">// These will be used to determine which of the loaded cells to perform blending on first.</span></div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>                <span class="comment">// We only need to do this if we didn&#39;t already do it above.</span></div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span>                <span class="keywordflow">if</span>(!didRecomputeScoresForLoadedCells &amp;&amp; supportScenarioBlending)</div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span>                {</div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span>                    ComputeStreamingScore(cameraPositionCellSpace, m_FrozenCameraDirection, m_LoadedCells);</div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span>                }</div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span> </div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>                <span class="keywordflow">if</span> (m_LoadMaxCellsPerFrame)</div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span>                    ComputeMinMaxStreamingScore();</div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span> </div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span>                <span class="comment">// Update internal load/toBeLoaded lists.</span></div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span> </div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span>                <span class="comment">// Move the successfully loaded cells to the &quot;loaded cells&quot; list.</span></div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span>                <span class="keywordflow">foreach</span> (var cell <span class="keywordflow">in</span> m_TempCellToLoadList)</div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span>                    m_ToBeLoadedCells.Remove(cell);</div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span>                m_LoadedCells.AddRange(m_TempCellToLoadList);</div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span>                <span class="comment">// Move the unloaded cells to the list of cells to be loaded.</span></div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>                <span class="keywordflow">if</span> (m_TempCellToUnloadList.size &gt; 0)</div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>                {</div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>                    <span class="keywordflow">foreach</span> (var cell <span class="keywordflow">in</span> m_TempCellToUnloadList)</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span>                        m_LoadedCells.Remove(cell);</div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span>                    ComputeCellGlobalInfo();</div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span>                }</div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span>                m_ToBeLoadedCells.AddRange(m_TempCellToUnloadList);</div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span> </div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span>                <span class="comment">// Clear temp lists.</span></div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span>                m_TempCellToLoadList.Clear();</div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span>                m_TempCellToUnloadList.Clear();</div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span> </div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span>                UpdateDiskStreaming(cmd);</div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span>            }</div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span> </div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span>            <span class="comment">// Handle cell streaming for blending</span></div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>            <span class="keywordflow">if</span> (supportScenarioBlending)</div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>            {</div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span>                <span class="keyword">using</span> (<span class="keyword">new</span> ProfilingScope(cmd, ProfilingSampler.Get(BXProfileId.APVScenarioBlendingUpdate)))</div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span>                    UpdateBlendingCellStreaming(cmd);</div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span>            }</div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>        }</div>
</div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span> </div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span>        <span class="keyword">private</span> <span class="keywordtype">int</span> FindWorstBlendingCellToBeLoaded()</div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span>        {</div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span>            <span class="keywordtype">int</span> idx = -1;</div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span>            <span class="keywordtype">float</span> worstBlending = -1;</div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span>            <span class="keywordtype">float</span> factor = <a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a9ed1b93bf407ee958f2eff108b148023">scenarioBlendingFactor</a>;</div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span>            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = m_TempBlendingCellToLoadList.<a class="code hl_property" href="class_b_x_render_pipeline_1_1_dynamic_array-1-g.html#abd35e7271b8c0ff05db8199e28594647">size</a>; i &lt; m_ToBeLoadedBlendingCells.<a class="code hl_property" href="class_b_x_render_pipeline_1_1_dynamic_array-1-g.html#abd35e7271b8c0ff05db8199e28594647">size</a>; ++i)</div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span>            {</div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>                <span class="keywordtype">float</span> score = Mathf.Abs(m_ToBeLoadedBlendingCells[i].blendingInfo.blendingFactor - factor);</div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>                <span class="keywordflow">if</span>(score &gt; worstBlending)</div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span>                {</div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span>                    idx = i;</div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span>                    <span class="keywordflow">if</span> (m_ToBeLoadedBlendingCells[i].blendingInfo.ShouldReupload()) <span class="comment">// We are not gonna find worse than that</span></div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span>                    worstBlending = score;</div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span>                }</div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span>            }</div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span> </div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span>            <span class="keywordflow">return</span> idx;</div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span>        }</div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span> </div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span>        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> BlendingComparer(Cell a, Cell b)</div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span>        {</div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span>            <span class="keywordflow">if</span> (a.blendingInfo.blendingFactor &lt; b.blendingInfo.blendingFactor)</div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span>                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a.blendingInfo.blendingFactor &gt; b.blendingInfo.blendingFactor)</div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span>                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>        }</div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span> </div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span>        <span class="keyword">private</span> <span class="keyword">static</span> DynamicArray&lt;Cell&gt;.SortComparer s_BlendingComparer = BlendingComparer;</div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span> </div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> UpdateBlendingCellStreaming(CommandBuffer cmd)</div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span>        {</div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span>            <span class="comment">// Compute the worst score to offset score of cells to prioritize</span></div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span>            <span class="keywordtype">float</span> worstLoaded = m_LoadedCells.size != 0 ? m_LoadedCells[m_LoadedCells.size - 1].streamingInfo.streamingScore : 0.0f;</div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span>            <span class="keywordtype">float</span> worstToBeLoaded = m_ToBeLoadedCells.size != 0 ? m_ToBeLoadedCells[m_ToBeLoadedCells.size - 1].streamingInfo.streamingScore : 0.0f;</div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span>            <span class="keywordtype">float</span> worstScore = Mathf.Max(worstLoaded, worstToBeLoaded);</div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span> </div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span>            ComputeBlendingScore(m_ToBeLoadedBlendingCells, worstScore);</div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span>            ComputeBlendingScore(m_LoadedBlendingCells, worstScore);</div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span> </div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span>            m_ToBeLoadedBlendingCells.QuickSort(s_BlendingComparer);</div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span>            m_LoadedBlendingCells.QuickSort(s_BlendingComparer);</div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span> </div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span>            <span class="keywordtype">int</span> cellCountToLoad = Mathf.Min(numberOfCellsLoadedPerFrame, m_ToBeLoadedBlendingCells.size);</div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span>            <span class="keywordflow">while</span>(m_TempBlendingCellToLoadList.size &lt; cellCountToLoad)</div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span>            {</div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span>                var blendingCell = m_ToBeLoadedBlendingCells[m_TempBlendingCellToLoadList.size];</div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span>                <span class="keywordflow">if</span> (!TryLoadBlendingCell(blendingCell, m_TempBlendingCellToLoadList))</div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span>                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span>            }</div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span> </div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span>            <span class="comment">// Budget reached</span></div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span>            <span class="keywordflow">if</span>(m_TempBlendingCellToLoadList.size != cellCountToLoad)</div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span>            {</div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span>                <span class="comment">// Turnover allows a percentage of the pool to be replaced by cells with a lower streaming score</span></div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span>                <span class="comment">// once the system is in a stable state. This ensures all cells get updated regularly.</span></div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span>                <span class="keywordtype">int</span> turnoverOffset = -1;</div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span>                <span class="keywordtype">int</span> idx = (int)(m_LoadedBlendingCells.size * (1f - <a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3bad87525c6f99d81e2e92d332107ae4">turnoverRate</a>));</div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span>                var worstNoTurnover = idx &lt; m_LoadedBlendingCells.size ? m_LoadedBlendingCells[idx] : <span class="keyword">null</span>;</div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span> </div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span>                <span class="keywordflow">while</span>(m_TempBlendingCellToLoadList.size &lt; cellCountToLoad)</div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span>                {</div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span>                    <span class="keywordflow">if</span> (m_LoadedBlendingCells.size - m_TempBlendingCellToUnloadList.size == 0) <span class="comment">// We unloaded everything</span></div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span> </div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span>                    var worstCellLoaded = m_LoadedBlendingCells[m_LoadedBlendingCells.size - m_TempBlendingCellToUnloadList.size - 1];</div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span>                    var bestCellToBeLoaded = m_ToBeLoadedBlendingCells[m_TempBlendingCellToLoadList.size];</div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span> </div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span>                    <span class="comment">// The best cell to be loaded has WORSE score than the worst cell already loaded.</span></div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span>                    <span class="comment">// This means all cells waiting to be loaded are worse than the ones we already have - we are in a &quot;stable&quot; state.</span></div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span>                    <span class="keywordflow">if</span>(bestCellToBeLoaded.blendingInfo.blendingScore &gt;= (worstNoTurnover ?? worstCellLoaded).blendingInfo.blendingScore)</div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span>                    {</div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span>                        <span class="keywordflow">if</span> (worstNoTurnover == <span class="keyword">null</span>) <span class="comment">// Disable turnover</span></div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span>                            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span> </div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span>                        <span class="comment">// Find worst cell and assume contiguous cells have roughly the same blending factor</span></div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span>                        <span class="comment">// (contiguous cells are spatially close by, so it&#39;s good anyway to update them together)</span></div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span>                        <span class="keywordflow">if</span> (turnoverOffset == -1)</div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span>                            turnoverOffset = FindWorstBlendingCellToBeLoaded();</div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span> </div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span>                        bestCellToBeLoaded = m_ToBeLoadedBlendingCells[turnoverOffset];</div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span>                        <span class="keywordflow">if</span> (bestCellToBeLoaded.blendingInfo.IsUpToDate()) <span class="comment">// Every single cell is blended :)</span></div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span>                            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span>                    }</div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span> </div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span>                    <span class="comment">// If we encounter a cell that is still being streamed in (and thus hasn&#39;t had a chance to be blended yet), bail</span></div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span>                    <span class="comment">// we don&#39;t want to keep unloading cells before they get blended, or we will never get any work done.</span></div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span>                    <span class="comment">// This branch is only ever true when disk streaming is being used.</span></div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span>                    <span class="keywordflow">if</span> (worstCellLoaded.streamingInfo.IsBlendingStreaming())</div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span> </div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span>                    UnloadBlendingCell(worstCellLoaded, m_TempBlendingCellToUnloadList);</div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span> </div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span>                    <span class="keywordflow">if</span> (probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span>                        LogStreaming($<span class="stringliteral">&quot;Unloading blending cell {worstCellLoaded.desc.index}&quot;</span>);</div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span> </div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span>                    <span class="keywordtype">bool</span> loadOk = TryLoadBlendingCell(bestCellToBeLoaded, m_TempBlendingCellToLoadList);</div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span> </div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span>                    <span class="comment">// Handle turnover. Loading can still fail cause all cells don&#39;t have the same chunk count.</span></div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span>                    <span class="keywordflow">if</span>(loadOk &amp;&amp; turnoverOffset != -1)</div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span>                    {</div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span>                        <span class="comment">// swap to ensure loaded cells are at the start of m_ToBeLoadedBlendingCells</span></div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span>                        m_ToBeLoadedBlendingCells[turnoverOffset] = m_ToBeLoadedBlendingCells[m_TempBlendingCellToLoadList.size - 1];</div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span>                        m_ToBeLoadedBlendingCells[m_TempBlendingCellToLoadList.size - 1] = bestCellToBeLoaded;</div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span>                        <span class="keywordflow">if</span> (++turnoverOffset &gt;= m_ToBeLoadedBlendingCells.size)</div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span>                            turnoverOffset = m_TempBlendingCellToLoadList.size;</div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span>                    }</div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span>                }</div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span> </div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span>                m_LoadedBlendingCells.RemoveRange(m_LoadedBlendingCells.size - m_TempBlendingCellToUnloadList.size, m_TempBlendingCellToUnloadList.size);</div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span>            }</div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span> </div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span>            m_ToBeLoadedBlendingCells.RemoveRange(0, m_TempBlendingCellToLoadList.size);</div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span>            m_LoadedBlendingCells.AddRange(m_TempBlendingCellToLoadList);</div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span>            m_TempBlendingCellToLoadList.Clear();</div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span>            m_ToBeLoadedBlendingCells.AddRange(m_TempBlendingCellToUnloadList);</div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span>            m_TempBlendingCellToUnloadList.Clear();</div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span> </div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span>            <span class="comment">// Kick off blending.</span></div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span>            <span class="keywordflow">if</span>(m_LoadedBlendingCells.size &gt; 0)</div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span>            {</div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span>                <span class="keywordtype">float</span> factor = <a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a9ed1b93bf407ee958f2eff108b148023">scenarioBlendingFactor</a>;</div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span> </div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span>                <span class="keywordtype">int</span> loadedBlendingCellIndex = 0;</div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span>                <span class="keywordtype">int</span> blendedCellCount = 0;</div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span>                <span class="keywordflow">while</span> (blendedCellCount &lt; <a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a7eab7cb9d69e825678f242112954861e">numberOfCellsBlendedPerFrame</a> &amp;&amp; loadedBlendingCellIndex &lt; m_LoadedBlendingCells.size)</div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span>                {</div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span>                    var blendingCell = m_LoadedBlendingCells[loadedBlendingCellIndex++];</div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span>                    <span class="keywordflow">if</span> (!blendingCell.streamingInfo.IsBlendingStreaming() &amp;&amp; !blendingCell.blendingInfo.IsUpToDate())</div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span>                    {</div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span>                        <span class="keywordflow">if</span> (probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span>                            LogStreaming($<span class="stringliteral">&quot;Blending cell {blendingCell.desc.index} ({factor})&quot;</span>);</div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span> </div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span>                        blendingCell.blendingInfo.blendingFactor = factor;</div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span>                        blendingCell.blendingInfo.MarkUpToDate();</div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span>                        m_BlendingPool.BlendChunks(blendingCell, m_Pool);</div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span>                        blendedCellCount++;</div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span>                    }</div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span>                }</div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span> </div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span>                m_BlendingPool.PerformBlending(cmd, factor, m_Pool);</div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span>            }</div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span>        }</div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span>        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> DefragComparer(Cell a, Cell b)</div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span>        {</div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span>            <span class="keywordflow">if</span> (a.indexInfo.updateInfo.GetNumberOfChunks() &gt; b.indexInfo.updateInfo.GetNumberOfChunks())</div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span>                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a.indexInfo.updateInfo.GetNumberOfChunks() &lt; b.indexInfo.updateInfo.GetNumberOfChunks())</div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span>                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span>            <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;</div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span>        }</div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span> </div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span>        <span class="keyword">private</span> <span class="keyword">static</span> DynamicArray&lt;Cell&gt;.SortComparer s_DefragComparer = DefragComparer;</div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span> </div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> StartIndexDefragmentation()</div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span>        {</div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span>            <span class="comment">// We can end up here during baking (dilation) when trying to load all cells even without supporting GPU streaming.</span></div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span>            <span class="keywordflow">if</span> (!m_SupportGPUStreaming)</div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span>                <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span> </div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span>            m_IndexDefragmentationInProgress = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span> </div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span>            <span class="comment">// Prepare the list of cells.</span></div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span>            <span class="comment">// We want to relocate cells with more indices first.</span></div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span>            m_IndexDefragCells.Clear();</div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span>            m_IndexDefragCells.AddRange(m_LoadedCells);</div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span>            m_IndexDefragCells.QuickSort(s_DefragComparer);</div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span> </div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span>            m_DefragIndex.Clear();</div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span>        }</div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span> </div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> UpdateIndexDefragmentation()</div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span>        {</div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span>            <span class="keyword">using</span>(<span class="keyword">new</span> ProfilingScope(<span class="keyword">null</span>, ProfilingSampler.Get(BXProfileId.APVIndexDefragUpdate)))</div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span>            {</div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span>                m_TempIndexDefragCells.Clear();</div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span> </div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span>                <span class="keywordtype">int</span> numberOfCellsToProcess = Mathf.Min(m_IndexDefragCells.size, numberOfCellsLoadedPerFrame);</div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span>                <span class="keywordtype">int</span> i = 0;</div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span>                <span class="keywordtype">int</span> processedCells = 0;</div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span>                <span class="keywordflow">while</span>(i &lt; m_IndexDefragCells.size &amp;&amp; processedCells &lt; numberOfCellsToProcess)</div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span>                {</div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span>                    var cell = m_IndexDefragCells[m_IndexDefragCells.size - i - 1];</div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span> </div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span>                    m_DefragIndex.FindSlotsForEntries(ref cell.indexInfo.updateInfo.entriesInfo);</div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span>                    m_DefragIndex.ReserveChunks(cell.indexInfo.updateInfo.entriesInfo, <span class="keyword">false</span>);</div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span> </div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span>                    <span class="comment">// Index of cells being streamed is not up to date yet so we can&#39;t defrag this cell.</span></div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span>                    <span class="keywordflow">if</span> (!(cell.streamingInfo.IsStreaming() || cell.streamingInfo.IsBlendingStreaming()))</div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span>                    {</div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span>                        <span class="comment">// Update index and indirection</span></div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span>                        m_DefragIndex.AddBricks(cell.indexInfo, cell.data.bricks, cell.poolInfo.chunkList, ProbeBrickPool.GetChunkSizeInBrickCount(), m_Pool.GetPoolWidth(), m_Pool.GetPoolHeight());</div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span>                        m_DefragCellIndices.UpdateCell(cell.indexInfo);</div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span>                        processedCells++;</div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span>                    }</div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span>                    <span class="keywordflow">else</span></div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span>                    {</div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span>                        m_TempIndexDefragCells.Add(cell);</div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span>                    }</div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span> </div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span>                    ++i;</div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span>                }</div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span> </div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span>                <span class="comment">// Remove processed cells from the list.</span></div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span>                <span class="comment">// For faster removal, just resize by removing all processed cells and add back those that were streaming.</span></div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span>                m_IndexDefragCells.Resize(m_IndexDefragCells.size - i);</div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span>                m_IndexDefragCells.AddRange(m_TempIndexDefragCells);</div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span> </div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span>                <span class="keywordflow">if</span> (m_IndexDefragCells.size == 0)</div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span>                {</div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span>                    <span class="comment">// Swap index buffers</span></div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span>                    var oldDefragIndex = m_DefragIndex;</div>
<div class="line"><a id="l01044" name="l01044"></a><span class="lineno"> 1044</span>                    m_DefragIndex = m_Index;</div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span>                    m_Index = oldDefragIndex;</div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span> </div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span>                    var oldDefragCellIndices = m_DefragCellIndices;</div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span>                    m_DefragCellIndices = m_CellIndices;</div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span>                    m_CellIndices = oldDefragCellIndices;</div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span> </div>
<div class="line"><a id="l01051" name="l01051"></a><span class="lineno"> 1051</span>                    <span class="comment">// Resume streaming</span></div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span>                    m_IndexDefragmentationInProgress = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span>                }</div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span>            }</div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span>        }</div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span> </div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span> </div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> OnStreamingComplete(CellStreamingRequest request, CommandBuffer cmd)</div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span>        {</div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span>            request.cell.streamingInfo.request = <span class="keyword">null</span>;</div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span>            UpdatePoolAndIndex(request.cell, request.scratchBuffer, request.scratchBufferLayout, request.poolIndex, cmd);</div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span>        }</div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span> </div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> OnBlendingStreamingComplete(CellStreamingRequest request, CommandBuffer cmd)</div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span>        {</div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span>            UpdatePool(cmd, request.cell.blendingInfo.chunkList, request.scratchBuffer, request.scratchBufferLayout, request.poolIndex);</div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span> </div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span>            <span class="keywordflow">if</span> (request.poolIndex == 0)</div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span>                request.cell.streamingInfo.blendingRequest0 = <span class="keyword">null</span>;</div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span>                request.cell.streamingInfo.blendingRequest1 = <span class="keyword">null</span>;</div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span> </div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span>            <span class="comment">// Streaming of both scenario is over, we can update the index and start blending.</span></div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span>            <span class="keywordflow">if</span> (request.cell.streamingInfo.blendingRequest0 == <span class="keyword">null</span> &amp;&amp; request.cell.streamingInfo.blendingRequest1 == <span class="keyword">null</span></div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span>                &amp;&amp; !request.cell.indexInfo.indexUpdated)</div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span>                UpdateCellIndex(request.cell);</div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span>        }</div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span> </div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> PushDiskStreamingRequest(Cell cell, <span class="keywordtype">string</span> scenario, <span class="keywordtype">int</span> poolIndex, CellStreamingRequest.OnStreamingCompeleteDelegate onStreamingCompelete)</div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span>        {</div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span>            var streamingRequest = m_StreamingRequestsPool.Get();</div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span>            streamingRequest.cell = cell;</div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span>            streamingRequest.state = CellStreamingRequest.State.Pending;</div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span>            streamingRequest.scenarioData = m_CurrentBakingSet.scenarios[scenario];</div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span>            streamingRequest.poolIndex = poolIndex;</div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span>            streamingRequest.onStreamingCompelete = onStreamingCompelete;</div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span> </div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span>            <span class="comment">// Only stream shared data for a regular streaming request (index -1 : no streaming)</span></div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span>            <span class="comment">// or the first scenario of the two blending scenarios (index 0)</span></div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span>            <span class="keywordflow">if</span> (poolIndex == -1 || poolIndex == 0)</div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span>                streamingRequest.streamSharedData = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span> </div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span>            <span class="keywordflow">if</span> (probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span>            {</div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span>                <span class="keywordflow">if</span> (poolIndex == -1)</div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span>                    LogStreaming($<span class="stringliteral">&quot;Push streaming request for cell {cell.desc.index}.&quot;</span>);</div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span>                    LogStreaming($<span class="stringliteral">&quot;Push streaming request for blending cell {cell.desc.index}.&quot;</span>);</div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span>            }</div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span> </div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span>            <span class="keywordflow">switch</span> (poolIndex)</div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span>            {</div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span>                <span class="keywordflow">case</span> -1:</div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span>                    cell.streamingInfo.request = streamingRequest;</div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span>                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span>                <span class="keywordflow">case</span> 0:</div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span>                    cell.streamingInfo.blendingRequest0 = streamingRequest;</div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span>                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"> 1109</span>                <span class="keywordflow">case</span> 1:</div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span>                    cell.streamingInfo.blendingRequest1 = streamingRequest;</div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span>                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span>            }</div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span> </div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span>            <span class="comment">// Enqueue request.</span></div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span>            m_StreamingQueue.Enqueue(streamingRequest);</div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span>        }</div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span> </div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> CancelStreamingRequest(Cell cell)</div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span>        {</div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span>            m_Index.RemoveBricks(cell.indexInfo);</div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"> 1121</span>            m_Pool.Deallocate(cell.poolInfo.chunkList);</div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span> </div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span>            <span class="keywordflow">if</span> (cell.streamingInfo.request != <span class="keyword">null</span>)</div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"> 1124</span>                cell.streamingInfo.request.Cancel();</div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span>        }</div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span> </div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> CancelBlendingStreamingRequest(Cell cell)</div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span>        {</div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span>            <span class="keywordflow">if</span> (cell.streamingInfo.blendingRequest0 != <span class="keyword">null</span>)</div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span>                cell.streamingInfo.blendingRequest0.Cancel();</div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span> </div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span>            <span class="keywordflow">if</span> (cell.streamingInfo.blendingRequest1 != <span class="keyword">null</span>)</div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span>                cell.streamingInfo.blendingRequest1.Cancel();</div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span>        }</div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span> </div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span>        <span class="keyword">private</span> unsafe <span class="keywordtype">bool</span> ProcessDiskStreamingRequest(CellStreamingRequest request)</div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span>        {</div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span>            var cellIndex = request.cell.desc.index;</div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span>            var cell = cells[cellIndex];</div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span>            var cellDesc = cell.desc;</div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span>            var cellData = cell.data;</div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span> </div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span>            <span class="keywordflow">if</span> (!m_ScratchBufferPool.AllocateScratchBuffer(cellDesc.shChunkCount, out var cellStreamingScratchBuffer, out var layout, m_DiskStreamingUseCompute))</div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"> 1144</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span> </div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span>            <span class="keywordflow">if</span> (!m_CurrentBakingSet.HasValidSharedData())</div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span>            {</div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span>                Debug.LogError($<span class="stringliteral">&quot;One or more data file missing for baking set {m_CurrentBakingSet.name}. Cannot load shared data.&quot;</span>);</div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span>            }</div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span> </div>
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"> 1152</span>            <span class="keywordflow">if</span> (!request.scenarioData.HasValidData(m_SHBands))</div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span>            {</div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span>                Debug.LogError($<span class="stringliteral">&quot;One or more data file missing for baking set {m_CurrentBakingSet.name} scenario {lightingScenario}. Cannot load scenario data.&quot;</span>);</div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span>            }</div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span> </div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span>            <span class="keywordflow">if</span> (probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"> 1159</span>            {</div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span>                <span class="keywordflow">if</span>(request.poolIndex == -1)</div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span>                    LogStreaming($<span class="stringliteral">&quot;Running disk streaming request for cell {cellDesc.index} ({cellDesc.shChunkCount} chunks)&quot;</span>);</div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span>                    LogStreaming($<span class="stringliteral">&quot;Running disk streaming request for cell {cellDesc.index} ({cellDesc.shChunkCount} chunks) for scenario {request.poolIndex}&quot;</span>);</div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span>            }</div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span> </div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span>            <span class="comment">// Note: We allocate new NativeArrays here.</span></div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span>            <span class="comment">// This will not generate GCAlloc since NativeArrays are value types but it will allocate on the native side.</span></div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span>            <span class="comment">// This is probably ok as the frequency should be pretty low but we need to keep an eye on this.</span></div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span> </div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span>            <span class="comment">// GPU Data</span></div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span>            request.scratchBuffer = cellStreamingScratchBuffer;</div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span>            request.scratchBufferLayout = layout;</div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span>            request.bytesWritten = 0;</div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span> </div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"> 1175</span>            var mappedBuffer = request.scratchBuffer.stagingBuffer;</div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span> </div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span>            var mappedBufferBaseAddr = (<span class="keywordtype">byte</span>*)mappedBuffer.GetUnsafePtr();</div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span>            var mappedBufferAddr = mappedBufferBaseAddr;</div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span> </div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span>            <span class="comment">// Write destination chunk coordinates for SH data</span></div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span>            var destChunkAddr = (uint*)mappedBufferAddr;</div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span>            <span class="comment">// Pool -1 is regular pool and 0/1 are blending pools.</span></div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span>            var destChunks = request.poolIndex == -1 ? request.cell.poolInfo.chunkList : request.cell.blendingInfo.chunkList;</div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span>            var destChunkCount = destChunks.Count;</div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"> 1185</span>            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; destChunkCount; ++i)</div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span>            {</div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span>                var destChunk = destChunks[i];</div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span>                destChunkAddr[i * 4] = (uint)destChunk.x;</div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span>                destChunkAddr[i * 4 + 1] = (uint)destChunk.y;</div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span>                destChunkAddr[i * 4 + 2] = (uint)destChunk.z;</div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span>                destChunkAddr[i * 4 + 3] = 0;</div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span>            }</div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span>            mappedBufferAddr += (destChunkCount * <span class="keyword">sizeof</span>(uint) * 4);</div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span> </div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span>            <span class="comment">// Write destination chunk coordinates for Shared data (always in main pool)</span></div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"> 1196</span>            destChunkAddr = (uint*)mappedBufferAddr;</div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span>            destChunks = request.cell.poolInfo.chunkList;</div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span>            Debug.Assert(destChunks.Count == destChunkCount);</div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"> 1199</span>            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; destChunkCount; ++i)</div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span>            {</div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"> 1201</span>                var destChunk = destChunks[i];</div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span>                destChunkAddr[i * 4] = (uint)destChunk.x;</div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span>                destChunkAddr[i * 4 + 1] = (uint)destChunk.y;</div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span>                destChunkAddr[i * 4 + 2] = (uint)destChunk.z;</div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span>                destChunkAddr[i * 4 + 3] = 0;</div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span>            }</div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span>            mappedBufferAddr += (destChunkCount * <span class="keyword">sizeof</span>(uint) * 4);</div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span> </div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span>            var shL0L1DataAsset = request.scenarioData.cellDataAsset;</div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span>            var cellStreamingDesc = shL0L1DataAsset.streamableCellDescs[cellIndex];</div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span>            var chunkCount = cellDesc.shChunkCount;</div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span>            var L0L1Size = m_CurrentBakingSet.L0ChunkSize * chunkCount;</div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span>            var L1Size = m_CurrentBakingSet.L1ChunkSize * chunkCount;</div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span> </div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span>            var L0L1ReadSize = L0L1Size + L1Size * 2;</div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span> </div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span>            request.cellDataStreamingRequest.AddReadCommand(cellStreamingDesc.offset, L0L1ReadSize, mappedBufferAddr);</div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span>            mappedBufferAddr += L0L1ReadSize;</div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span>            request.bytesWritten += request.cellDataStreamingRequest.RunCommands(shL0L1DataAsset.OpenFile());</div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span> </div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"> 1221</span>            <span class="keywordflow">if</span> (request.streamSharedData)</div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span>            {</div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span>                var sharedDataAsset = m_CurrentBakingSet.cellSharedDataAsset;</div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span>                cellStreamingDesc = sharedDataAsset.streamableCellDescs[cellIndex];</div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span>                var sharedDataReadSize = m_CurrentBakingSet.sharedDataChunkSize * chunkCount;</div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"> 1226</span> </div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span>                request.cellSharedDataStreamingRequest.AddReadCommand(cellStreamingDesc.offset, sharedDataReadSize, mappedBufferAddr);</div>
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"> 1228</span>                mappedBufferAddr += sharedDataReadSize;</div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span>                request.bytesWritten += request.cellSharedDataStreamingRequest.RunCommands(sharedDataAsset.OpenFile());</div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span>            }</div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span> </div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span>            <span class="keywordflow">if</span>(m_SHBands == <a class="code hl_enumeration" href="namespace_b_x_render_pipeline.html#ab990d971caf1a583df90e2d5967b1aaa">ProbeVolumeSHBands</a>.SphericalHarmonicsL2)</div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span>            {</div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span>                var optionalDataAsset = request.scenarioData.cellOptionalDataAsset;</div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span>                cellStreamingDesc = optionalDataAsset.streamableCellDescs[cellIndex];</div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span>                var L2ReadSize = m_CurrentBakingSet.L2TextureChunkSize * chunkCount * 4; <span class="comment">// 4 Textures</span></div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span>                request.cellOptionalDataStreamingRequest.AddReadCommand(cellStreamingDesc.offset, L2ReadSize, mappedBufferAddr);</div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span>                mappedBufferAddr += L2ReadSize;</div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span>                request.bytesWritten += request.cellOptionalDataStreamingRequest.RunCommands(optionalDataAsset.OpenFile());</div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span>            }</div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span> </div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span>            <span class="keywordflow">if</span> (m_CurrentBakingSet.bakedProbeOcclusion)</div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span>            {</div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span>                var probeOcclusionDataAsset = request.scenarioData.cellProbeOcclusionDataAsset;</div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span>                cellStreamingDesc = probeOcclusionDataAsset.streamableCellDescs[cellIndex];</div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span>                var probeOcclusionReadSize = m_CurrentBakingSet.ProbeOcclusionChunkSize * chunkCount;</div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span>                request.cellProbeOcclusionDataStreamingRequest.AddReadCommand(cellStreamingDesc.offset, probeOcclusionReadSize, mappedBufferAddr);</div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span>                mappedBufferAddr += probeOcclusionReadSize;</div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span>                request.bytesWritten += request.cellProbeOcclusionDataStreamingRequest.RunCommands(probeOcclusionDataAsset.OpenFile());</div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span>            }</div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span> </div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span>            <span class="comment">// Bricks Data</span></div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span>            cellData.bricks = <span class="keyword">new</span> NativeArray&lt;ProbeBrickIndex.Brick&gt;(cellDesc.bricksCount, Allocator.Persistent, NativeArrayOptions.UninitializedMemory);</div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span> </div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span>            var brickDataAsset = m_CurrentBakingSet.cellBricksDataAsset;</div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span>            cellStreamingDesc = brickDataAsset.streamableCellDescs[cellIndex];</div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span>            request.brickStreamingRequest.AddReadCommand(cellStreamingDesc.offset, brickDataAsset.elementSize * Mathf.Min(cellStreamingDesc.elementCount, cellDesc.bricksCount), (<span class="keywordtype">byte</span>*)cellData.bricks.GetUnsafePtr());</div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span>            request.brickStreamingRequest.RunCommands(brickDataAsset.OpenFile());</div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span> </div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span>            <span class="comment">// Support Data</span></div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span>            <span class="keywordflow">if</span> (m_CurrentBakingSet.HasSupportData())</div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span>            {</div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span>                var supportDataAsset = m_CurrentBakingSet.cellSupportDataAsset;</div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span>                cellStreamingDesc = supportDataAsset.streamableCellDescs[cellIndex];</div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span> </div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span>                var supportOffset = cellStreamingDesc.offset;</div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span>                var positionSize = cellStreamingDesc.elementCount * m_CurrentBakingSet.supportPositionChunkSize;</div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span>                var touchupSize = cellStreamingDesc.elementCount * m_CurrentBakingSet.supportTouchupChunkSize;</div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span>                var offsetsSize = cellStreamingDesc.elementCount * m_CurrentBakingSet.supportOffsetsChunkSize;</div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span>                var layerSize = cellStreamingDesc.elementCount * m_CurrentBakingSet.supportLayerMaskChunkSize;</div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span>                var validitySize = cellStreamingDesc.elementCount * m_CurrentBakingSet.supportValidityChunkSize;</div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span> </div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span>                cellData.probePositions = (<span class="keyword">new</span> NativeArray&lt;byte&gt;(positionSize, Allocator.Persistent, NativeArrayOptions.UninitializedMemory)).Reinterpret&lt;Vector3&gt;(1);</div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span>                cellData.validity = (<span class="keyword">new</span> NativeArray&lt;byte&gt;(validitySize, Allocator.Persistent, NativeArrayOptions.UninitializedMemory)).Reinterpret&lt;float&gt;(1);</div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span>                cellData.layer = (<span class="keyword">new</span> NativeArray&lt;byte&gt;(layerSize, Allocator.Persistent, NativeArrayOptions.UninitializedMemory)).Reinterpret&lt;byte&gt;(1);</div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span>                cellData.touchupVolumeInteraction = (<span class="keyword">new</span> NativeArray&lt;byte&gt;(touchupSize, Allocator.Persistent, NativeArrayOptions.UninitializedMemory)).Reinterpret&lt;float&gt;(1);</div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span>                cellData.offsetVectors = (<span class="keyword">new</span> NativeArray&lt;byte&gt;(offsetsSize, Allocator.Persistent, NativeArrayOptions.UninitializedMemory)).Reinterpret&lt;Vector3&gt;(1);</div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span> </div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span>                request.supportStreamingRequest.AddReadCommand(supportOffset, positionSize, (<span class="keywordtype">byte</span>*)cellData.probePositions.GetUnsafePtr());</div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span>                supportOffset += positionSize;</div>
<div class="line"><a id="l01281" name="l01281"></a><span class="lineno"> 1281</span>                request.supportStreamingRequest.AddReadCommand(supportOffset, validitySize, (<span class="keywordtype">byte</span>*)cellData.validity.GetUnsafePtr());</div>
<div class="line"><a id="l01282" name="l01282"></a><span class="lineno"> 1282</span>                supportOffset += validitySize;</div>
<div class="line"><a id="l01283" name="l01283"></a><span class="lineno"> 1283</span>                request.supportStreamingRequest.AddReadCommand(supportOffset, touchupSize, (<span class="keywordtype">byte</span>*)cellData.touchupVolumeInteraction.GetUnsafePtr());</div>
<div class="line"><a id="l01284" name="l01284"></a><span class="lineno"> 1284</span>                supportOffset += touchupSize;</div>
<div class="line"><a id="l01285" name="l01285"></a><span class="lineno"> 1285</span>                request.supportStreamingRequest.AddReadCommand(supportOffset, layerSize, (<span class="keywordtype">byte</span>*)cellData.layer.GetUnsafePtr());</div>
<div class="line"><a id="l01286" name="l01286"></a><span class="lineno"> 1286</span>                supportOffset += layerSize;</div>
<div class="line"><a id="l01287" name="l01287"></a><span class="lineno"> 1287</span>                request.supportStreamingRequest.AddReadCommand(supportOffset, offsetsSize, (<span class="keywordtype">byte</span>*)cellData.offsetVectors.GetUnsafePtr());</div>
<div class="line"><a id="l01288" name="l01288"></a><span class="lineno"> 1288</span>                request.supportStreamingRequest.RunCommands(supportDataAsset.OpenFile());</div>
<div class="line"><a id="l01289" name="l01289"></a><span class="lineno"> 1289</span>            }</div>
<div class="line"><a id="l01290" name="l01290"></a><span class="lineno"> 1290</span> </div>
<div class="line"><a id="l01291" name="l01291"></a><span class="lineno"> 1291</span>            request.state = CellStreamingRequest.State.Active;</div>
<div class="line"><a id="l01292" name="l01292"></a><span class="lineno"> 1292</span>            m_ActiveStreamingRequests.Add(request);</div>
<div class="line"><a id="l01293" name="l01293"></a><span class="lineno"> 1293</span> </div>
<div class="line"><a id="l01294" name="l01294"></a><span class="lineno"> 1294</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l01295" name="l01295"></a><span class="lineno"> 1295</span>        }</div>
<div class="line"><a id="l01296" name="l01296"></a><span class="lineno"> 1296</span> </div>
<div class="line"><a id="l01297" name="l01297"></a><span class="lineno"> 1297</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> AllocateScratchBufferPoolIfNeeded()</div>
<div class="line"><a id="l01298" name="l01298"></a><span class="lineno"> 1298</span>        {</div>
<div class="line"><a id="l01299" name="l01299"></a><span class="lineno"> 1299</span>            <span class="keywordflow">if</span> (m_SupportDiskStreaming)</div>
<div class="line"><a id="l01300" name="l01300"></a><span class="lineno"> 1300</span>            {</div>
<div class="line"><a id="l01301" name="l01301"></a><span class="lineno"> 1301</span>                <span class="keywordtype">int</span> shChunkSize = m_CurrentBakingSet.GetChunkGPUMemory(m_SHBands);</div>
<div class="line"><a id="l01302" name="l01302"></a><span class="lineno"> 1302</span>                <span class="keywordtype">int</span> maxSHChunkCount = m_CurrentBakingSet.maxSHChunkCount;</div>
<div class="line"><a id="l01303" name="l01303"></a><span class="lineno"> 1303</span> </div>
<div class="line"><a id="l01304" name="l01304"></a><span class="lineno"> 1304</span>                Debug.Assert(shChunkSize % 4 == 0);</div>
<div class="line"><a id="l01305" name="l01305"></a><span class="lineno"> 1305</span> </div>
<div class="line"><a id="l01306" name="l01306"></a><span class="lineno"> 1306</span>                <span class="comment">// Recreate if chunk size or max count is different.</span></div>
<div class="line"><a id="l01307" name="l01307"></a><span class="lineno"> 1307</span>                <span class="keywordflow">if</span>(m_ScratchBufferPool == <span class="keyword">null</span> || m_ScratchBufferPool.chunkSize != shChunkSize || m_ScratchBufferPool.maxChunkCount != maxSHChunkCount)</div>
<div class="line"><a id="l01308" name="l01308"></a><span class="lineno"> 1308</span>                {</div>
<div class="line"><a id="l01309" name="l01309"></a><span class="lineno"> 1309</span>                    <span class="keywordflow">if</span> (probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l01310" name="l01310"></a><span class="lineno"> 1310</span>                        LogStreaming($<span class="stringliteral">&quot;Allocating new Scratch Buffer Pool. Chunk size: {shChunkSize}, max SH Chunks: {maxSHChunkCount}&quot;</span>);</div>
<div class="line"><a id="l01311" name="l01311"></a><span class="lineno"> 1311</span> </div>
<div class="line"><a id="l01312" name="l01312"></a><span class="lineno"> 1312</span>                    <span class="keywordflow">if</span> (m_ScratchBufferPool != <span class="keyword">null</span>)</div>
<div class="line"><a id="l01313" name="l01313"></a><span class="lineno"> 1313</span>                        m_ScratchBufferPool.Cleanup();</div>
<div class="line"><a id="l01314" name="l01314"></a><span class="lineno"> 1314</span> </div>
<div class="line"><a id="l01315" name="l01315"></a><span class="lineno"> 1315</span>                    m_ScratchBufferPool = <span class="keyword">new</span> ProbeVolumeScratchBufferPool(m_CurrentBakingSet, m_SHBands);</div>
<div class="line"><a id="l01316" name="l01316"></a><span class="lineno"> 1316</span>                }</div>
<div class="line"><a id="l01317" name="l01317"></a><span class="lineno"> 1317</span>            }</div>
<div class="line"><a id="l01318" name="l01318"></a><span class="lineno"> 1318</span>        }</div>
<div class="line"><a id="l01319" name="l01319"></a><span class="lineno"> 1319</span> </div>
<div class="line"><a id="l01320" name="l01320"></a><span class="lineno"> 1320</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> UpdateActiveRequests(CommandBuffer cmd)</div>
<div class="line"><a id="l01321" name="l01321"></a><span class="lineno"> 1321</span>        {</div>
<div class="line"><a id="l01322" name="l01322"></a><span class="lineno"> 1322</span>            <span class="keywordflow">if</span>(m_ActiveStreamingRequests.Count &gt; 0)</div>
<div class="line"><a id="l01323" name="l01323"></a><span class="lineno"> 1323</span>            {</div>
<div class="line"><a id="l01324" name="l01324"></a><span class="lineno"> 1324</span>                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = m_ActiveStreamingRequests.Count - 1; i &gt;= 0; --i)</div>
<div class="line"><a id="l01325" name="l01325"></a><span class="lineno"> 1325</span>                {</div>
<div class="line"><a id="l01326" name="l01326"></a><span class="lineno"> 1326</span>                    var request = m_ActiveStreamingRequests[i];</div>
<div class="line"><a id="l01327" name="l01327"></a><span class="lineno"> 1327</span>                    <span class="comment">// Can&#39;t String.Format in an assert message without generating garbage :/</span></div>
<div class="line"><a id="l01328" name="l01328"></a><span class="lineno"> 1328</span>                    <span class="comment">//Debug.Assert(request.state != CellStreamingRequest.State.Pending, $&quot;Wrong status for request {request.cell.desc.index}: {request.state}&quot;);</span></div>
<div class="line"><a id="l01329" name="l01329"></a><span class="lineno"> 1329</span>                    Debug.Assert(request.state != CellStreamingRequest.State.Pending, <span class="stringliteral">&quot;Wrong status for request&quot;</span>);</div>
<div class="line"><a id="l01330" name="l01330"></a><span class="lineno"> 1330</span> </div>
<div class="line"><a id="l01331" name="l01331"></a><span class="lineno"> 1331</span>                    <span class="keywordtype">bool</span> releaseRequest = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01332" name="l01332"></a><span class="lineno"> 1332</span> </div>
<div class="line"><a id="l01333" name="l01333"></a><span class="lineno"> 1333</span>                    <span class="keywordflow">if</span>(request.state == CellStreamingRequest.State.Canceled)</div>
<div class="line"><a id="l01334" name="l01334"></a><span class="lineno"> 1334</span>                    {</div>
<div class="line"><a id="l01335" name="l01335"></a><span class="lineno"> 1335</span>                        <span class="keywordflow">if</span> (probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l01336" name="l01336"></a><span class="lineno"> 1336</span>                            LogStreaming($<span class="stringliteral">&quot;Discarding active request for cell {request.cell.desc.index}&quot;</span>);</div>
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"> 1337</span> </div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"> 1338</span>                        m_ScratchBufferPool.ReleaseScratchBuffer(request.scratchBuffer);</div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span>                        releaseRequest = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span>                    }</div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span>                    <span class="keywordflow">else</span></div>
<div class="line"><a id="l01342" name="l01342"></a><span class="lineno"> 1342</span>                    {</div>
<div class="line"><a id="l01343" name="l01343"></a><span class="lineno"> 1343</span>                        request.UpdateState();</div>
<div class="line"><a id="l01344" name="l01344"></a><span class="lineno"> 1344</span> </div>
<div class="line"><a id="l01345" name="l01345"></a><span class="lineno"> 1345</span>                        <span class="keywordflow">if</span>(request.state == CellStreamingRequest.State.Complete)</div>
<div class="line"><a id="l01346" name="l01346"></a><span class="lineno"> 1346</span>                        {</div>
<div class="line"><a id="l01347" name="l01347"></a><span class="lineno"> 1347</span>                            Debug.Assert(cmd != <span class="keyword">null</span>); <span class="comment">// We should not get here during cleanup.</span></div>
<div class="line"><a id="l01348" name="l01348"></a><span class="lineno"> 1348</span> </div>
<div class="line"><a id="l01349" name="l01349"></a><span class="lineno"> 1349</span>                            <span class="keywordflow">if</span> (probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l01350" name="l01350"></a><span class="lineno"> 1350</span>                            {</div>
<div class="line"><a id="l01351" name="l01351"></a><span class="lineno"> 1351</span>                                <span class="keywordflow">if</span>(request.poolIndex == -1)</div>
<div class="line"><a id="l01352" name="l01352"></a><span class="lineno"> 1352</span>                                    LogStreaming($<span class="stringliteral">&quot;Completed disk streaming request for cell {request.cell.desc.index}&quot;</span>);</div>
<div class="line"><a id="l01353" name="l01353"></a><span class="lineno"> 1353</span>                                <span class="keywordflow">else</span></div>
<div class="line"><a id="l01354" name="l01354"></a><span class="lineno"> 1354</span>                                    LogStreaming($<span class="stringliteral">&quot;Completed disk streaming request for blending cell {request.cell.desc.index} for scenario {request.poolIndex}&quot;</span>);</div>
<div class="line"><a id="l01355" name="l01355"></a><span class="lineno"> 1355</span>                            }</div>
<div class="line"><a id="l01356" name="l01356"></a><span class="lineno"> 1356</span> </div>
<div class="line"><a id="l01357" name="l01357"></a><span class="lineno"> 1357</span>                            <span class="comment">// Because of limitation of low level device implementation of Lock/Unlock on Graphics Buffers</span></div>
<div class="line"><a id="l01358" name="l01358"></a><span class="lineno"> 1358</span>                            <span class="comment">// (the fact that locking over multiple frames isn&#39;t really supported)</span></div>
<div class="line"><a id="l01359" name="l01359"></a><span class="lineno"> 1359</span>                            <span class="comment">// We need to go through a temporary buffer and copy into the GraphicsBuffer when streaming is done.</span></div>
<div class="line"><a id="l01360" name="l01360"></a><span class="lineno"> 1360</span>                            <span class="comment">// This can be a first step to later on, use compressed data on disk to lighten the I/O load and decompress</span></div>
<div class="line"><a id="l01361" name="l01361"></a><span class="lineno"> 1361</span>                            <span class="comment">// directly in the graphics buffer.</span></div>
<div class="line"><a id="l01362" name="l01362"></a><span class="lineno"> 1362</span>                            <span class="keywordflow">if</span>(request.scratchBuffer.buffer != <span class="keyword">null</span>)</div>
<div class="line"><a id="l01363" name="l01363"></a><span class="lineno"> 1363</span>                            {</div>
<div class="line"><a id="l01364" name="l01364"></a><span class="lineno"> 1364</span>                                var mappedBuffer = request.scratchBuffer.buffer.LockBufferForWrite&lt;<span class="keywordtype">byte</span>&gt;(0, request.scratchBuffer.stagingBuffer.Length);</div>
<div class="line"><a id="l01365" name="l01365"></a><span class="lineno"> 1365</span>                                mappedBuffer.CopyFrom(request.scratchBuffer.stagingBuffer);</div>
<div class="line"><a id="l01366" name="l01366"></a><span class="lineno"> 1366</span>                                request.scratchBuffer.buffer.UnlockBufferAfterWrite&lt;<span class="keywordtype">byte</span>&gt;(request.scratchBuffer.stagingBuffer.Length);</div>
<div class="line"><a id="l01367" name="l01367"></a><span class="lineno"> 1367</span>                            }</div>
<div class="line"><a id="l01368" name="l01368"></a><span class="lineno"> 1368</span>                            request.onStreamingCompelete(request, cmd);</div>
<div class="line"><a id="l01369" name="l01369"></a><span class="lineno"> 1369</span> </div>
<div class="line"><a id="l01370" name="l01370"></a><span class="lineno"> 1370</span>                            <span class="comment">// We can release here because the GraphicsBuffer inside the scratchBuffer is double buffered.</span></div>
<div class="line"><a id="l01371" name="l01371"></a><span class="lineno"> 1371</span>                            <span class="comment">// So a new request on next frame won&#39;t overlap.</span></div>
<div class="line"><a id="l01372" name="l01372"></a><span class="lineno"> 1372</span>                            m_ScratchBufferPool.ReleaseScratchBuffer(request.scratchBuffer);</div>
<div class="line"><a id="l01373" name="l01373"></a><span class="lineno"> 1373</span>                            releaseRequest = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01374" name="l01374"></a><span class="lineno"> 1374</span>                        }</div>
<div class="line"><a id="l01375" name="l01375"></a><span class="lineno"> 1375</span>                        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(request.state == CellStreamingRequest.State.Invalid)</div>
<div class="line"><a id="l01376" name="l01376"></a><span class="lineno"> 1376</span>                        {</div>
<div class="line"><a id="l01377" name="l01377"></a><span class="lineno"> 1377</span>                            <span class="keywordflow">if</span>(probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l01378" name="l01378"></a><span class="lineno"> 1378</span>                                LogStreaming($<span class="stringliteral">&quot;Reseting invalid request for cell {request.cell.desc.index}&quot;</span>);</div>
<div class="line"><a id="l01379" name="l01379"></a><span class="lineno"> 1379</span> </div>
<div class="line"><a id="l01380" name="l01380"></a><span class="lineno"> 1380</span>                            <span class="comment">// If invalid, try to run it again.</span></div>
<div class="line"><a id="l01381" name="l01381"></a><span class="lineno"> 1381</span>                            m_ScratchBufferPool.ReleaseScratchBuffer(request.scratchBuffer);</div>
<div class="line"><a id="l01382" name="l01382"></a><span class="lineno"> 1382</span>                            request.Reset();</div>
<div class="line"><a id="l01383" name="l01383"></a><span class="lineno"> 1383</span>                            m_ActiveStreamingRequests.RemoveAt(i);</div>
<div class="line"><a id="l01384" name="l01384"></a><span class="lineno"> 1384</span>                            m_StreamingQueue.Enqueue(request);</div>
<div class="line"><a id="l01385" name="l01385"></a><span class="lineno"> 1385</span>                        }</div>
<div class="line"><a id="l01386" name="l01386"></a><span class="lineno"> 1386</span>                    }</div>
<div class="line"><a id="l01387" name="l01387"></a><span class="lineno"> 1387</span> </div>
<div class="line"><a id="l01388" name="l01388"></a><span class="lineno"> 1388</span>                    <span class="keywordflow">if</span> (releaseRequest)</div>
<div class="line"><a id="l01389" name="l01389"></a><span class="lineno"> 1389</span>                    {</div>
<div class="line"><a id="l01390" name="l01390"></a><span class="lineno"> 1390</span>                        m_ActiveStreamingRequests.RemoveAt(i);</div>
<div class="line"><a id="l01391" name="l01391"></a><span class="lineno"> 1391</span>                        m_StreamingRequestsPool.Release(request);</div>
<div class="line"><a id="l01392" name="l01392"></a><span class="lineno"> 1392</span>                    }</div>
<div class="line"><a id="l01393" name="l01393"></a><span class="lineno"> 1393</span>                }</div>
<div class="line"><a id="l01394" name="l01394"></a><span class="lineno"> 1394</span>            }</div>
<div class="line"><a id="l01395" name="l01395"></a><span class="lineno"> 1395</span>        }</div>
<div class="line"><a id="l01396" name="l01396"></a><span class="lineno"> 1396</span> </div>
<div class="line"><a id="l01397" name="l01397"></a><span class="lineno"> 1397</span>        <span class="keyword">private</span> unsafe <span class="keywordtype">void</span> ProcessNewRequests()</div>
<div class="line"><a id="l01398" name="l01398"></a><span class="lineno"> 1398</span>        {</div>
<div class="line"><a id="l01399" name="l01399"></a><span class="lineno"> 1399</span>            <span class="keywordflow">while</span>(m_StreamingQueue.TryPeek(out var request))</div>
<div class="line"><a id="l01400" name="l01400"></a><span class="lineno"> 1400</span>            {</div>
<div class="line"><a id="l01401" name="l01401"></a><span class="lineno"> 1401</span>                <span class="keywordflow">if</span>(request.state == CellStreamingRequest.State.Canceled)</div>
<div class="line"><a id="l01402" name="l01402"></a><span class="lineno"> 1402</span>                {</div>
<div class="line"><a id="l01403" name="l01403"></a><span class="lineno"> 1403</span>                    <span class="keywordflow">if</span> (probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l01404" name="l01404"></a><span class="lineno"> 1404</span>                    {</div>
<div class="line"><a id="l01405" name="l01405"></a><span class="lineno"> 1405</span>                        <span class="keywordflow">if</span>(request.poolIndex == -1)</div>
<div class="line"><a id="l01406" name="l01406"></a><span class="lineno"> 1406</span>                            LogStreaming($<span class="stringliteral">&quot;Discarding request for cell {request.cell.desc.index}&quot;</span>);</div>
<div class="line"><a id="l01407" name="l01407"></a><span class="lineno"> 1407</span>                        <span class="keywordflow">else</span></div>
<div class="line"><a id="l01408" name="l01408"></a><span class="lineno"> 1408</span>                            LogStreaming($<span class="stringliteral">&quot;Discarding request for blending cell {request.cell.desc.index} for scenario {request.poolIndex}&quot;</span>);</div>
<div class="line"><a id="l01409" name="l01409"></a><span class="lineno"> 1409</span>                    }</div>
<div class="line"><a id="l01410" name="l01410"></a><span class="lineno"> 1410</span> </div>
<div class="line"><a id="l01411" name="l01411"></a><span class="lineno"> 1411</span>                    Debug.Assert(request.scratchBuffer == <span class="keyword">null</span>);</div>
<div class="line"><a id="l01412" name="l01412"></a><span class="lineno"> 1412</span>                    m_StreamingRequestsPool.Release(request);</div>
<div class="line"><a id="l01413" name="l01413"></a><span class="lineno"> 1413</span>                    m_StreamingQueue.Dequeue(); <span class="comment">//  Discard request.</span></div>
<div class="line"><a id="l01414" name="l01414"></a><span class="lineno"> 1414</span>                }</div>
<div class="line"><a id="l01415" name="l01415"></a><span class="lineno"> 1415</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l01416" name="l01416"></a><span class="lineno"> 1416</span>                {</div>
<div class="line"><a id="l01417" name="l01417"></a><span class="lineno"> 1417</span>                    Debug.Assert(request.state == CellStreamingRequest.State.Pending);</div>
<div class="line"><a id="l01418" name="l01418"></a><span class="lineno"> 1418</span>                    Debug.Assert(request.cell.data != <span class="keyword">null</span>); <span class="comment">// Need data for bricks and support data.</span></div>
<div class="line"><a id="l01419" name="l01419"></a><span class="lineno"> 1419</span> </div>
<div class="line"><a id="l01420" name="l01420"></a><span class="lineno"> 1420</span>                    <span class="keywordflow">if</span> (ProcessDiskStreamingRequest(request))</div>
<div class="line"><a id="l01421" name="l01421"></a><span class="lineno"> 1421</span>                    {</div>
<div class="line"><a id="l01422" name="l01422"></a><span class="lineno"> 1422</span>                        m_StreamingQueue.Dequeue();</div>
<div class="line"><a id="l01423" name="l01423"></a><span class="lineno"> 1423</span>                    }</div>
<div class="line"><a id="l01424" name="l01424"></a><span class="lineno"> 1424</span>                    <span class="keywordflow">else</span></div>
<div class="line"><a id="l01425" name="l01425"></a><span class="lineno"> 1425</span>                    {</div>
<div class="line"><a id="l01426" name="l01426"></a><span class="lineno"> 1426</span>                        <span class="comment">// No available scratch buffer for this request.</span></div>
<div class="line"><a id="l01427" name="l01427"></a><span class="lineno"> 1427</span>                        <span class="comment">// Since we want to conserve order in the queue, we don&#39;t process any more requests this frame.</span></div>
<div class="line"><a id="l01428" name="l01428"></a><span class="lineno"> 1428</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01429" name="l01429"></a><span class="lineno"> 1429</span>                    }</div>
<div class="line"><a id="l01430" name="l01430"></a><span class="lineno"> 1430</span>                }</div>
<div class="line"><a id="l01431" name="l01431"></a><span class="lineno"> 1431</span>            }</div>
<div class="line"><a id="l01432" name="l01432"></a><span class="lineno"> 1432</span>        }</div>
<div class="line"><a id="l01433" name="l01433"></a><span class="lineno"> 1433</span> </div>
<div class="line"><a id="l01434" name="l01434"></a><span class="lineno"> 1434</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> UpdateDiskStreaming(CommandBuffer cmd)</div>
<div class="line"><a id="l01435" name="l01435"></a><span class="lineno"> 1435</span>        {</div>
<div class="line"><a id="l01436" name="l01436"></a><span class="lineno"> 1436</span>            <span class="keywordflow">if</span> (!diskStreamingEnabled)</div>
<div class="line"><a id="l01437" name="l01437"></a><span class="lineno"> 1437</span>                <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l01438" name="l01438"></a><span class="lineno"> 1438</span> </div>
<div class="line"><a id="l01439" name="l01439"></a><span class="lineno"> 1439</span>            <span class="keyword">using</span>(<span class="keyword">new</span> ProfilingScope(<span class="keyword">null</span>, ProfilingSampler.Get(BXProfileId.APVDiskStreamingUpdate)))</div>
<div class="line"><a id="l01440" name="l01440"></a><span class="lineno"> 1440</span>            {</div>
<div class="line"><a id="l01441" name="l01441"></a><span class="lineno"> 1441</span>                AllocateScratchBufferPoolIfNeeded();</div>
<div class="line"><a id="l01442" name="l01442"></a><span class="lineno"> 1442</span>                ProcessNewRequests();</div>
<div class="line"><a id="l01443" name="l01443"></a><span class="lineno"> 1443</span>                UpdateActiveRequests(cmd);</div>
<div class="line"><a id="l01444" name="l01444"></a><span class="lineno"> 1444</span> </div>
<div class="line"><a id="l01445" name="l01445"></a><span class="lineno"> 1445</span>                <span class="comment">// Close file handles if not needed anymore.</span></div>
<div class="line"><a id="l01446" name="l01446"></a><span class="lineno"> 1446</span>                <span class="comment">// Checking cellBricksDataAsset here just to know if any of the files is open. If one if open, all of them should be.</span></div>
<div class="line"><a id="l01447" name="l01447"></a><span class="lineno"> 1447</span>                <span class="keywordflow">if</span>(m_ActiveStreamingRequests.Count == 0 &amp;&amp; m_StreamingQueue.Count == 0 &amp;&amp; m_CurrentBakingSet.cellBricksDataAsset != <span class="keyword">null</span> &amp;&amp; m_CurrentBakingSet.cellBricksDataAsset.IsOpen())</div>
<div class="line"><a id="l01448" name="l01448"></a><span class="lineno"> 1448</span>                {</div>
<div class="line"><a id="l01449" name="l01449"></a><span class="lineno"> 1449</span>                    <span class="keywordflow">if</span>(probeVolumeDebug.verboseStreamingLog)</div>
<div class="line"><a id="l01450" name="l01450"></a><span class="lineno"> 1450</span>                        LogStreaming(<span class="stringliteral">&quot;Closing files open for APV disk streaming.&quot;</span>);</div>
<div class="line"><a id="l01451" name="l01451"></a><span class="lineno"> 1451</span> </div>
<div class="line"><a id="l01452" name="l01452"></a><span class="lineno"> 1452</span>                    m_CurrentBakingSet.cellBricksDataAsset.CloseFile();</div>
<div class="line"><a id="l01453" name="l01453"></a><span class="lineno"> 1453</span>                    m_CurrentBakingSet.cellSupportDataAsset.CloseFile();</div>
<div class="line"><a id="l01454" name="l01454"></a><span class="lineno"> 1454</span>                    m_CurrentBakingSet.cellSharedDataAsset.CloseFile();</div>
<div class="line"><a id="l01455" name="l01455"></a><span class="lineno"> 1455</span> </div>
<div class="line"><a id="l01456" name="l01456"></a><span class="lineno"> 1456</span>                    <span class="keywordflow">if</span>(m_CurrentBakingSet.scenarios.TryGetValue(<a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#afb6970d042bc02dc1babd7d4f70e31e5">lightingScenario</a>, out var scenarioData))</div>
<div class="line"><a id="l01457" name="l01457"></a><span class="lineno"> 1457</span>                    {</div>
<div class="line"><a id="l01458" name="l01458"></a><span class="lineno"> 1458</span>                        scenarioData.cellDataAsset.CloseFile();</div>
<div class="line"><a id="l01459" name="l01459"></a><span class="lineno"> 1459</span>                        scenarioData.cellOptionalDataAsset.CloseFile();</div>
<div class="line"><a id="l01460" name="l01460"></a><span class="lineno"> 1460</span>                        scenarioData.cellProbeOcclusionDataAsset.CloseFile();</div>
<div class="line"><a id="l01461" name="l01461"></a><span class="lineno"> 1461</span>                    }</div>
<div class="line"><a id="l01462" name="l01462"></a><span class="lineno"> 1462</span> </div>
<div class="line"><a id="l01463" name="l01463"></a><span class="lineno"> 1463</span>                    <span class="keywordflow">if</span>(!<span class="keywordtype">string</span>.IsNullOrEmpty(<a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a6d99eb5f08b23b5fa09f23a53f0ee155">otherScenario</a>) &amp;&amp; m_CurrentBakingSet.scenarios.TryGetValue(<a class="code hl_property" href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#afb6970d042bc02dc1babd7d4f70e31e5">lightingScenario</a>, out var otherScenarioData))</div>
<div class="line"><a id="l01464" name="l01464"></a><span class="lineno"> 1464</span>                    {</div>
<div class="line"><a id="l01465" name="l01465"></a><span class="lineno"> 1465</span>                        otherScenarioData.cellDataAsset.CloseFile();</div>
<div class="line"><a id="l01466" name="l01466"></a><span class="lineno"> 1466</span>                        otherScenarioData.cellOptionalDataAsset.CloseFile();</div>
<div class="line"><a id="l01467" name="l01467"></a><span class="lineno"> 1467</span>                        otherScenarioData.cellProbeOcclusionDataAsset.CloseFile();</div>
<div class="line"><a id="l01468" name="l01468"></a><span class="lineno"> 1468</span>                    }</div>
<div class="line"><a id="l01469" name="l01469"></a><span class="lineno"> 1469</span>                }</div>
<div class="line"><a id="l01470" name="l01470"></a><span class="lineno"> 1470</span>            }</div>
<div class="line"><a id="l01471" name="l01471"></a><span class="lineno"> 1471</span> </div>
<div class="line"><a id="l01472" name="l01472"></a><span class="lineno"> 1472</span>            <span class="comment">// Debug flag to force unload/reload of cells to be able to debug streaming shader code.</span></div>
<div class="line"><a id="l01473" name="l01473"></a><span class="lineno"> 1473</span>            <span class="keywordflow">if</span>(probeVolumeDebug.debugStreaming)</div>
<div class="line"><a id="l01474" name="l01474"></a><span class="lineno"> 1474</span>            {</div>
<div class="line"><a id="l01475" name="l01475"></a><span class="lineno"> 1475</span>                <span class="keywordflow">if</span> (m_ToBeLoadedCells.size == 0 &amp;&amp; m_ActiveStreamingRequests.Count == 0)</div>
<div class="line"><a id="l01476" name="l01476"></a><span class="lineno"> 1476</span>                    UnloadAllCells();</div>
<div class="line"><a id="l01477" name="l01477"></a><span class="lineno"> 1477</span>            }</div>
<div class="line"><a id="l01478" name="l01478"></a><span class="lineno"> 1478</span>        }</div>
<div class="line"><a id="l01479" name="l01479"></a><span class="lineno"> 1479</span> </div>
<div class="line"><a id="l01480" name="l01480"></a><span class="lineno"> 1480</span> </div>
<div class="line"><a id="l01481" name="l01481"></a><span class="lineno"> 1481</span>        <span class="keyword">private</span> <span class="keywordtype">bool</span> HasActiveStreamingRequest(Cell cell)</div>
<div class="line"><a id="l01482" name="l01482"></a><span class="lineno"> 1482</span>        {</div>
<div class="line"><a id="l01483" name="l01483"></a><span class="lineno"> 1483</span>            <span class="keywordflow">return</span> diskStreamingEnabled &amp;&amp; m_ActiveStreamingRequests.Exists(x =&gt; x.cell == cell);</div>
<div class="line"><a id="l01484" name="l01484"></a><span class="lineno"> 1484</span>        }</div>
<div class="line"><a id="l01485" name="l01485"></a><span class="lineno"> 1485</span> </div>
<div class="line"><a id="l01486" name="l01486"></a><span class="lineno"> 1486</span>        [Conditional(<span class="stringliteral">&quot;UNITY_EDITOR&quot;</span>)]</div>
<div class="line"><a id="l01487" name="l01487"></a><span class="lineno"> 1487</span>        [Conditional(<span class="stringliteral">&quot;DEVELOPMENT_BUILD&quot;</span>)]</div>
<div class="line"><a id="l01488" name="l01488"></a><span class="lineno"> 1488</span>        <span class="keyword">private</span> <span class="keywordtype">void</span> LogStreaming(<span class="keywordtype">string</span> log)</div>
<div class="line"><a id="l01489" name="l01489"></a><span class="lineno"> 1489</span>        {</div>
<div class="line"><a id="l01490" name="l01490"></a><span class="lineno"> 1490</span>            Debug.Log(log);</div>
<div class="line"><a id="l01491" name="l01491"></a><span class="lineno"> 1491</span>        }</div>
<div class="line"><a id="l01492" name="l01492"></a><span class="lineno"> 1492</span>    }</div>
<div class="line"><a id="l01493" name="l01493"></a><span class="lineno"> 1493</span>}</div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_dynamic_array-1-g_html_abd35e7271b8c0ff05db8199e28594647"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_dynamic_array-1-g.html#abd35e7271b8c0ff05db8199e28594647">BXRenderPipeline.DynamicArray-1-g.size</a></div><div class="ttdeci">int size</div><div class="ttdoc">Number of elements in the array. There may be more elements allocated. Use capacity to query the numb...</div><div class="ttdef"><b>Definition</b> <a href="_dynamic_array_8cs_source.html#l00022">DynamicArray.cs:22</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html">BXRenderPipeline.ProbeReferenceVolume</a></div><div class="ttdoc">The reference volume for the Adaptive Probe Volums system. This defines the structure in which volume...</div><div class="ttdef"><b>Definition</b> <a href="_probe_reference_volume_8_binding_8cs_source.html#l00008">ProbeReferenceVolume.Binding.cs:9</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html_a3a0771648f1d82379509866ce0ca87af"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3a0771648f1d82379509866ce0ca87af">BXRenderPipeline.ProbeReferenceVolume.UpdateCellStreaming</a></div><div class="ttdeci">void UpdateCellStreaming(CommandBuffer cmd, Camera camera)</div><div class="ttdoc">Updates the cell streaming for a Camera</div><div class="ttdef"><b>Definition</b> <a href="#l00622">ProbeReferenceVolume.Streaming.cs:622</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html_a3bad87525c6f99d81e2e92d332107ae4"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3bad87525c6f99d81e2e92d332107ae4">BXRenderPipeline.ProbeReferenceVolume.turnoverRate</a></div><div class="ttdeci">float turnoverRate</div><div class="ttdoc">Percentage of cells loaded in the blending pool that can be replaced by out of date cells.</div><div class="ttdef"><b>Definition</b> <a href="#l00349">ProbeReferenceVolume.Streaming.cs:350</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html_a3ef101369ba2153ba30b9212185f6a26"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a3ef101369ba2153ba30b9212185f6a26">BXRenderPipeline.ProbeReferenceVolume.SetNumberOfCellsLoadedPerFrame</a></div><div class="ttdeci">void SetNumberOfCellsLoadedPerFrame(int numberOfCells)</div><div class="ttdoc">Set the number of cells that are loaded per frame when needed. This number is capped at 10.</div><div class="ttdef"><b>Definition</b> <a href="#l00322">ProbeReferenceVolume.Streaming.cs:322</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html_a6d99eb5f08b23b5fa09f23a53f0ee155"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a6d99eb5f08b23b5fa09f23a53f0ee155">BXRenderPipeline.ProbeReferenceVolume.otherScenario</a></div><div class="ttdeci">string otherScenario</div><div class="ttdoc">The lighting scenario APV is blending toward.</div><div class="ttdef"><b>Definition</b> <a href="_probe_reference_volume_8cs_source.html#l00861">ProbeReferenceVolume.cs:862</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html_a7eab7cb9d69e825678f242112954861e"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a7eab7cb9d69e825678f242112954861e">BXRenderPipeline.ProbeReferenceVolume.numberOfCellsBlendedPerFrame</a></div><div class="ttdeci">int numberOfCellsBlendedPerFrame</div><div class="ttdoc">Maximum number of cells that are blended per frame.</div><div class="ttdef"><b>Definition</b> <a href="#l00339">ProbeReferenceVolume.Streaming.cs:340</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html_a91758a40094d4965422f95e8e818661c"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a91758a40094d4965422f95e8e818661c">BXRenderPipeline.ProbeReferenceVolume.isInitialized</a></div><div class="ttdeci">bool isInitialized</div><div class="ttdoc">Is Probe Volume initialized.</div><div class="ttdef"><b>Definition</b> <a href="_probe_reference_volume_8cs_source.html#l00792">ProbeReferenceVolume.cs:792</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html_a9d1ed2f6fa0098440b5af9e9dc10e637"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a9d1ed2f6fa0098440b5af9e9dc10e637">BXRenderPipeline.ProbeReferenceVolume.UpdateCellStreaming</a></div><div class="ttdeci">void UpdateCellStreaming(CommandBuffer cmd, Camera camera, ProbeVolumesOptions options)</div><div class="ttdoc">Updates the cell streaming for a Camera</div><div class="ttdef"><b>Definition</b> <a href="#l00633">ProbeReferenceVolume.Streaming.cs:633</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html_a9ed1b93bf407ee958f2eff108b148023"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#a9ed1b93bf407ee958f2eff108b148023">BXRenderPipeline.ProbeReferenceVolume.scenarioBlendingFactor</a></div><div class="ttdeci">float scenarioBlendingFactor</div><div class="ttdoc">The blending factor currently used to blend probe data. A value of 0 means blending is not active.</div><div class="ttdef"><b>Definition</b> <a href="_probe_reference_volume_8cs_source.html#l00867">ProbeReferenceVolume.cs:868</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html_af2f32385d2f6bab0b12b5273aedfb6f7"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#af2f32385d2f6bab0b12b5273aedfb6f7">BXRenderPipeline.ProbeReferenceVolume.EnableMaxCellStreaming</a></div><div class="ttdeci">void EnableMaxCellStreaming(bool value)</div><div class="ttdoc">Enable streaming as many cells per frame as possible.</div><div class="ttdef"><b>Definition</b> <a href="#l00310">ProbeReferenceVolume.Streaming.cs:310</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_reference_volume_html_afb6970d042bc02dc1babd7d4f70e31e5"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_reference_volume.html#afb6970d042bc02dc1babd7d4f70e31e5">BXRenderPipeline.ProbeReferenceVolume.lightingScenario</a></div><div class="ttdeci">string lightingScenario</div><div class="ttdoc">The active lighting scenario.</div><div class="ttdef"><b>Definition</b> <a href="_probe_reference_volume_8cs_source.html#l00851">ProbeReferenceVolume.cs:852</a></div></div>
<div class="ttc" id="aclass_b_x_render_pipeline_1_1_probe_volumes_options_html"><div class="ttname"><a href="class_b_x_render_pipeline_1_1_probe_volumes_options.html">BXRenderPipeline.ProbeVolumesOptions</a></div><div class="ttdoc">A volume component that holds settings for the Adaptive Probe Volumes System per-camera options.</div><div class="ttdef"><b>Definition</b> <a href="_probe_volumes_options_8cs_source.html#l00013">ProbeVolumesOptions.cs:14</a></div></div>
<div class="ttc" id="aclass_camera_html"><div class="ttname"><a href="class_camera.html">Camera</a></div><div class="ttdef"><b>Definition</b> <a href="_camera_8h_source.html#l00009">Camera.h:10</a></div></div>
<div class="ttc" id="aclass_debug_html"><div class="ttname"><a href="class_debug.html">Debug</a></div><div class="ttdef"><b>Definition</b> <a href="_debug_8h_source.html#l00009">Debug.h:10</a></div></div>
<div class="ttc" id="anamespace_b_x_render_pipeline_html"><div class="ttname"><a href="namespace_b_x_render_pipeline.html">BXRenderPipeline</a></div><div class="ttdef"><b>Definition</b> <a href="_b_x_additional_light_data_8_types_8cs_source.html#l00006">BXAdditionalLightData.Types.cs:7</a></div></div>
<div class="ttc" id="anamespace_b_x_render_pipeline_html_aa4a4b71e220a1b4f3576b66a92e49bf3a6f6cb72d544962fa333e2e34ce64f719"><div class="ttname"><a href="namespace_b_x_render_pipeline.html#aa4a4b71e220a1b4f3576b66a92e49bf3a6f6cb72d544962fa333e2e34ce64f719">BXRenderPipeline.DebugProbeShadingMode.Size</a></div><div class="ttdeci">@ Size</div><div class="ttdoc">Base on size.</div><div class="ttdef"><b>Definition</b> <a href="_probe_reference_volume_8_debug_8cs_source.html#l00053">ProbeReferenceVolume.Debug.cs:53</a></div></div>
<div class="ttc" id="anamespace_b_x_render_pipeline_html_ab990d971caf1a583df90e2d5967b1aaa"><div class="ttname"><a href="namespace_b_x_render_pipeline.html#ab990d971caf1a583df90e2d5967b1aaa">BXRenderPipeline.ProbeVolumeSHBands</a></div><div class="ttdeci">ProbeVolumeSHBands</div><div class="ttdoc">Number of Spherical Harmonics bands that are used with Probe Volumes.</div><div class="ttdef"><b>Definition</b> <a href="_probe_reference_volume_8cs_source.html#l00200">ProbeReferenceVolume.cs:201</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_f73a8b7d50989afdadf24d8fc7357a9a.html">FloowDream</a></li><li class="navelem"><a class="el" href="dir_1ba945c5ec581c9e331de81f300aff07.html">Assets</a></li><li class="navelem"><a class="el" href="dir_a57f4778d467e0a6236fa4788364df6c.html">Scripts</a></li><li class="navelem"><a class="el" href="dir_8b4148ef0ffda13d8a8272867298b61d.html">BXRenderPipeline</a></li><li class="navelem"><a class="el" href="dir_adca635a4a56f63b57dcbe3faea75e30.html">ProbeVolumes</a></li><li class="navelem"><b>ProbeReferenceVolume.Streaming.cs</b></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
